<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=emulateIE7" />
    <title>Coverage for /tmp/parts/odoo/addons/account/models/account_payment.py: 26%</title>
    <link rel="icon" sizes="32x32" href="favicon_32.png">
    <link rel="stylesheet" href="style.css" type="text/css">
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="jquery.hotkeys.js"></script>
    <script type="text/javascript" src="jquery.isonscreen.js"></script>
    <script type="text/javascript" src="coverage_html.js"></script>
    <script type="text/javascript">
        jQuery(document).ready(coverage.pyfile_ready);
    </script>
</head>
<body class="pyfile">
<div id="header">
    <div class="content">
        <h1>Coverage for <b>/tmp/parts/odoo/addons/account/models/account_payment.py</b> :
            <span class="pc_cov">26%</span>
        </h1>
        <img id="keyboard_icon" src="keybd_closed.png" alt="Show keyboard shortcuts" />
        <h2 class="stats">
            327 statements &nbsp;
            <button type="button" class="run shortkey_r button_toggle_run" title="Toggle lines run">84 run</button>
            <button type="button" class="mis show_mis shortkey_m button_toggle_mis" title="Toggle lines missing">243 missing</button>
            <button type="button" class="exc show_exc shortkey_x button_toggle_exc" title="Toggle lines excluded">0 excluded</button>
        </h2>
    </div>
</div>
<div class="help_panel">
    <img id="panel_icon" src="keybd_open.png" alt="Hide keyboard shortcuts" />
    <p class="legend">Hot-keys on this page</p>
    <div>
    <p class="keyhelp">
        <span class="key">r</span>
        <span class="key">m</span>
        <span class="key">x</span>
        <span class="key">p</span> &nbsp; toggle line displays
    </p>
    <p class="keyhelp">
        <span class="key">j</span>
        <span class="key">k</span> &nbsp; next/prev highlighted chunk
    </p>
    <p class="keyhelp">
        <span class="key">0</span> &nbsp; (zero) top of page
    </p>
    <p class="keyhelp">
        <span class="key">1</span> &nbsp; (one) first highlighted chunk
    </p>
    </div>
</div>
<div id="source">
    <p id="t1" class="pln"><span class="n"><a href="#t1">1</a></span><span class="t"><span class="com"># -*- coding: utf-8 -*-</span>&nbsp;</span><span class="r"></span></p>
    <p id="t2" class="pln"><span class="n"><a href="#t2">2</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t3" class="run"><span class="n"><a href="#t3">3</a></span><span class="t"><span class="key">from</span> <span class="nam">odoo</span> <span class="key">import</span> <span class="nam">models</span><span class="op">,</span> <span class="nam">fields</span><span class="op">,</span> <span class="nam">api</span><span class="op">,</span> <span class="nam">_</span>&nbsp;</span><span class="r"></span></p>
    <p id="t4" class="run"><span class="n"><a href="#t4">4</a></span><span class="t"><span class="key">from</span> <span class="nam">odoo</span><span class="op">.</span><span class="nam">exceptions</span> <span class="key">import</span> <span class="nam">UserError</span><span class="op">,</span> <span class="nam">ValidationError</span>&nbsp;</span><span class="r"></span></p>
    <p id="t5" class="pln"><span class="n"><a href="#t5">5</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t6" class="run"><span class="n"><a href="#t6">6</a></span><span class="t"><span class="nam">MAP_INVOICE_TYPE_PARTNER_TYPE</span> <span class="op">=</span> <span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t7" class="pln"><span class="n"><a href="#t7">7</a></span><span class="t">    <span class="str">'out_invoice'</span><span class="op">:</span> <span class="str">'customer'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t8" class="pln"><span class="n"><a href="#t8">8</a></span><span class="t">    <span class="str">'out_refund'</span><span class="op">:</span> <span class="str">'customer'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t9" class="pln"><span class="n"><a href="#t9">9</a></span><span class="t">    <span class="str">'in_invoice'</span><span class="op">:</span> <span class="str">'supplier'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t10" class="pln"><span class="n"><a href="#t10">10</a></span><span class="t">    <span class="str">'in_refund'</span><span class="op">:</span> <span class="str">'supplier'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t11" class="pln"><span class="n"><a href="#t11">11</a></span><span class="t"><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t12" class="pln"><span class="n"><a href="#t12">12</a></span><span class="t"><span class="com"># Since invoice amounts are unsigned, this is how we know if money comes in or goes out</span>&nbsp;</span><span class="r"></span></p>
    <p id="t13" class="run"><span class="n"><a href="#t13">13</a></span><span class="t"><span class="nam">MAP_INVOICE_TYPE_PAYMENT_SIGN</span> <span class="op">=</span> <span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t14" class="pln"><span class="n"><a href="#t14">14</a></span><span class="t">    <span class="str">'out_invoice'</span><span class="op">:</span> <span class="num">1</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t15" class="pln"><span class="n"><a href="#t15">15</a></span><span class="t">    <span class="str">'in_refund'</span><span class="op">:</span> <span class="num">1</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t16" class="pln"><span class="n"><a href="#t16">16</a></span><span class="t">    <span class="str">'in_invoice'</span><span class="op">:</span> <span class="op">-</span><span class="num">1</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t17" class="pln"><span class="n"><a href="#t17">17</a></span><span class="t">    <span class="str">'out_refund'</span><span class="op">:</span> <span class="op">-</span><span class="num">1</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t18" class="pln"><span class="n"><a href="#t18">18</a></span><span class="t"><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t19" class="pln"><span class="n"><a href="#t19">19</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t20" class="run"><span class="n"><a href="#t20">20</a></span><span class="t"><span class="key">class</span> <span class="nam">account_payment_method</span><span class="op">(</span><span class="nam">models</span><span class="op">.</span><span class="nam">Model</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t21" class="run"><span class="n"><a href="#t21">21</a></span><span class="t">    <span class="nam">_name</span> <span class="op">=</span> <span class="str">"account.payment.method"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t22" class="run"><span class="n"><a href="#t22">22</a></span><span class="t">    <span class="nam">_description</span> <span class="op">=</span> <span class="str">"Payment Methods"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t23" class="pln"><span class="n"><a href="#t23">23</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t24" class="run"><span class="n"><a href="#t24">24</a></span><span class="t">    <span class="nam">name</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Char</span><span class="op">(</span><span class="nam">required</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">translate</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t25" class="run"><span class="n"><a href="#t25">25</a></span><span class="t">    <span class="nam">code</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Char</span><span class="op">(</span><span class="nam">required</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>  <span class="com"># For internal identification</span>&nbsp;</span><span class="r"></span></p>
    <p id="t26" class="run"><span class="n"><a href="#t26">26</a></span><span class="t">    <span class="nam">payment_type</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Selection</span><span class="op">(</span><span class="op">[</span><span class="op">(</span><span class="str">'inbound'</span><span class="op">,</span> <span class="str">'Inbound'</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="str">'outbound'</span><span class="op">,</span> <span class="str">'Outbound'</span><span class="op">)</span><span class="op">]</span><span class="op">,</span> <span class="nam">required</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t27" class="pln"><span class="n"><a href="#t27">27</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t28" class="pln"><span class="n"><a href="#t28">28</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t29" class="run"><span class="n"><a href="#t29">29</a></span><span class="t"><span class="key">class</span> <span class="nam">account_abstract_payment</span><span class="op">(</span><span class="nam">models</span><span class="op">.</span><span class="nam">AbstractModel</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t30" class="run"><span class="n"><a href="#t30">30</a></span><span class="t">    <span class="nam">_name</span> <span class="op">=</span> <span class="str">"account.abstract.payment"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t31" class="run"><span class="n"><a href="#t31">31</a></span><span class="t">    <span class="nam">_description</span> <span class="op">=</span> <span class="str">"Contains the logic shared between models which allows to register payments"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t32" class="pln"><span class="n"><a href="#t32">32</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t33" class="run"><span class="n"><a href="#t33">33</a></span><span class="t">    <span class="nam">payment_type</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Selection</span><span class="op">(</span><span class="op">[</span><span class="op">(</span><span class="str">'outbound'</span><span class="op">,</span> <span class="str">'Send Money'</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="str">'inbound'</span><span class="op">,</span> <span class="str">'Receive Money'</span><span class="op">)</span><span class="op">]</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Payment Type'</span><span class="op">,</span> <span class="nam">required</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t34" class="run"><span class="n"><a href="#t34">34</a></span><span class="t">    <span class="nam">payment_method_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'account.payment.method'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Payment Method Type'</span><span class="op">,</span> <span class="nam">required</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">oldname</span><span class="op">=</span><span class="str">"payment_method"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t35" class="run"><span class="n"><a href="#t35">35</a></span><span class="t">    <span class="nam">payment_method_code</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Char</span><span class="op">(</span><span class="nam">related</span><span class="op">=</span><span class="str">'payment_method_id.code'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t36" class="pln"><span class="n"><a href="#t36">36</a></span><span class="t">        <span class="nam">help</span><span class="op">=</span><span class="str">"Technical field used to adapt the interface to the payment type selected."</span><span class="op">,</span> <span class="nam">readonly</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t37" class="pln"><span class="n"><a href="#t37">37</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t38" class="run"><span class="n"><a href="#t38">38</a></span><span class="t">    <span class="nam">partner_type</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Selection</span><span class="op">(</span><span class="op">[</span><span class="op">(</span><span class="str">'customer'</span><span class="op">,</span> <span class="str">'Customer'</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="str">'supplier'</span><span class="op">,</span> <span class="str">'Vendor'</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t39" class="run"><span class="n"><a href="#t39">39</a></span><span class="t">    <span class="nam">partner_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'res.partner'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Partner'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t40" class="pln"><span class="n"><a href="#t40">40</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t41" class="run"><span class="n"><a href="#t41">41</a></span><span class="t">    <span class="nam">amount</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Monetary</span><span class="op">(</span><span class="nam">string</span><span class="op">=</span><span class="str">'Payment Amount'</span><span class="op">,</span> <span class="nam">required</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t42" class="run"><span class="n"><a href="#t42">42</a></span><span class="t">    <span class="nam">currency_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'res.currency'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Currency'</span><span class="op">,</span> <span class="nam">required</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">default</span><span class="op">=</span><span class="key">lambda</span> <span class="nam">self</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">user</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t43" class="run"><span class="n"><a href="#t43">43</a></span><span class="t">    <span class="nam">payment_date</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Date</span><span class="op">(</span><span class="nam">string</span><span class="op">=</span><span class="str">'Payment Date'</span><span class="op">,</span> <span class="nam">default</span><span class="op">=</span><span class="nam">fields</span><span class="op">.</span><span class="nam">Date</span><span class="op">.</span><span class="nam">context_today</span><span class="op">,</span> <span class="nam">required</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">copy</span><span class="op">=</span><span class="nam">False</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t44" class="run"><span class="n"><a href="#t44">44</a></span><span class="t">    <span class="nam">communication</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Char</span><span class="op">(</span><span class="nam">string</span><span class="op">=</span><span class="str">'Memo'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t45" class="run"><span class="n"><a href="#t45">45</a></span><span class="t">    <span class="nam">journal_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'account.journal'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Payment Journal'</span><span class="op">,</span> <span class="nam">required</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">domain</span><span class="op">=</span><span class="op">[</span><span class="op">(</span><span class="str">'type'</span><span class="op">,</span> <span class="str">'in'</span><span class="op">,</span> <span class="op">(</span><span class="str">'bank'</span><span class="op">,</span> <span class="str">'cash'</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t46" class="run"><span class="n"><a href="#t46">46</a></span><span class="t">    <span class="nam">company_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'res.company'</span><span class="op">,</span> <span class="nam">related</span><span class="op">=</span><span class="str">'journal_id.company_id'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Company'</span><span class="op">,</span> <span class="nam">readonly</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t47" class="pln"><span class="n"><a href="#t47">47</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t48" class="run"><span class="n"><a href="#t48">48</a></span><span class="t">    <span class="nam">hide_payment_method</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Boolean</span><span class="op">(</span><span class="nam">compute</span><span class="op">=</span><span class="str">'_compute_hide_payment_method'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t49" class="pln"><span class="n"><a href="#t49">49</a></span><span class="t">        <span class="nam">help</span><span class="op">=</span><span class="str">"Technical field used to hide the payment method if the selected journal has only one available which is 'manual'"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t50" class="pln"><span class="n"><a href="#t50">50</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t51" class="run"><span class="n"><a href="#t51">51</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">one</span>&nbsp;</span><span class="r"></span></p>
    <p id="t52" class="run"><span class="n"><a href="#t52">52</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">constrains</span><span class="op">(</span><span class="str">'amount'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t53" class="pln"><span class="n"><a href="#t53">53</a></span><span class="t">    <span class="key">def</span> <span class="nam">_check_amount</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t54" class="mis show_mis"><span class="n"><a href="#t54">54</a></span><span class="t">        <span class="key">if</span> <span class="key">not</span> <span class="nam">self</span><span class="op">.</span><span class="nam">amount</span> <span class="op">></span> <span class="num">0.0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t55" class="mis show_mis"><span class="n"><a href="#t55">55</a></span><span class="t">            <span class="key">raise</span> <span class="nam">ValidationError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'The payment amount must be strictly positive.'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t56" class="pln"><span class="n"><a href="#t56">56</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t57" class="run"><span class="n"><a href="#t57">57</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">one</span>&nbsp;</span><span class="r"></span></p>
    <p id="t58" class="run"><span class="n"><a href="#t58">58</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">depends</span><span class="op">(</span><span class="str">'payment_type'</span><span class="op">,</span> <span class="str">'journal_id'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t59" class="pln"><span class="n"><a href="#t59">59</a></span><span class="t">    <span class="key">def</span> <span class="nam">_compute_hide_payment_method</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t60" class="mis show_mis"><span class="n"><a href="#t60">60</a></span><span class="t">        <span class="key">if</span> <span class="key">not</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t61" class="mis show_mis"><span class="n"><a href="#t61">61</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">hide_payment_method</span> <span class="op">=</span> <span class="nam">True</span>&nbsp;</span><span class="r"></span></p>
    <p id="t62" class="mis show_mis"><span class="n"><a href="#t62">62</a></span><span class="t">            <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p id="t63" class="mis show_mis"><span class="n"><a href="#t63">63</a></span><span class="t">        <span class="nam">journal_payment_methods</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_type</span> <span class="op">==</span> <span class="str">'inbound'</span> <span class="key">and</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">inbound_payment_method_ids</span> <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">outbound_payment_method_ids</span>&nbsp;</span><span class="r"></span></p>
    <p id="t64" class="mis show_mis"><span class="n"><a href="#t64">64</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">hide_payment_method</span> <span class="op">=</span> <span class="nam">len</span><span class="op">(</span><span class="nam">journal_payment_methods</span><span class="op">)</span> <span class="op">==</span> <span class="num">1</span> <span class="key">and</span> <span class="nam">journal_payment_methods</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">code</span> <span class="op">==</span> <span class="str">'manual'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t65" class="pln"><span class="n"><a href="#t65">65</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t66" class="run"><span class="n"><a href="#t66">66</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">onchange</span><span class="op">(</span><span class="str">'journal_id'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t67" class="pln"><span class="n"><a href="#t67">67</a></span><span class="t">    <span class="key">def</span> <span class="nam">_onchange_journal</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t68" class="mis show_mis"><span class="n"><a href="#t68">68</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t69" class="mis show_mis"><span class="n"><a href="#t69">69</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">currency_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t70" class="pln"><span class="n"><a href="#t70">70</a></span><span class="t">            <span class="com"># Set default payment method (we consider the first to be the default one)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t71" class="mis show_mis"><span class="n"><a href="#t71">71</a></span><span class="t">            <span class="nam">payment_methods</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_type</span> <span class="op">==</span> <span class="str">'inbound'</span> <span class="key">and</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">inbound_payment_method_ids</span> <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">outbound_payment_method_ids</span>&nbsp;</span><span class="r"></span></p>
    <p id="t72" class="mis show_mis"><span class="n"><a href="#t72">72</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">payment_method_id</span> <span class="op">=</span> <span class="nam">payment_methods</span> <span class="key">and</span> <span class="nam">payment_methods</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">or</span> <span class="nam">False</span>&nbsp;</span><span class="r"></span></p>
    <p id="t73" class="pln"><span class="n"><a href="#t73">73</a></span><span class="t">            <span class="com"># Set payment method domain (restrict to methods enabled for the journal and to selected payment type)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t74" class="mis show_mis"><span class="n"><a href="#t74">74</a></span><span class="t">            <span class="nam">payment_type</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_type</span> <span class="key">in</span> <span class="op">(</span><span class="str">'outbound'</span><span class="op">,</span> <span class="str">'transfer'</span><span class="op">)</span> <span class="key">and</span> <span class="str">'outbound'</span> <span class="key">or</span> <span class="str">'inbound'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t75" class="mis show_mis"><span class="n"><a href="#t75">75</a></span><span class="t">            <span class="key">return</span> <span class="op">{</span><span class="str">'domain'</span><span class="op">:</span> <span class="op">{</span><span class="str">'payment_method_id'</span><span class="op">:</span> <span class="op">[</span><span class="op">(</span><span class="str">'payment_type'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="nam">payment_type</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="str">'id'</span><span class="op">,</span> <span class="str">'in'</span><span class="op">,</span> <span class="nam">payment_methods</span><span class="op">.</span><span class="nam">ids</span><span class="op">)</span><span class="op">]</span><span class="op">}</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t76" class="mis show_mis"><span class="n"><a href="#t76">76</a></span><span class="t">        <span class="key">return</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t77" class="pln"><span class="n"><a href="#t77">77</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t78" class="run"><span class="n"><a href="#t78">78</a></span><span class="t">    <span class="key">def</span> <span class="nam">_get_invoices</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t79" class="pln"><span class="n"><a href="#t79">79</a></span><span class="t">        <span class="str">""" Return the invoices of the payment. Must be overridden """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t80" class="mis show_mis"><span class="n"><a href="#t80">80</a></span><span class="t">        <span class="key">raise</span> <span class="nam">NotImplementedError</span>&nbsp;</span><span class="r"></span></p>
    <p id="t81" class="pln"><span class="n"><a href="#t81">81</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t82" class="run"><span class="n"><a href="#t82">82</a></span><span class="t">    <span class="key">def</span> <span class="nam">_compute_total_invoices_amount</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t83" class="pln"><span class="n"><a href="#t83">83</a></span><span class="t">        <span class="str">""" Compute the sum of the residual of invoices, expressed in the payment currency """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t84" class="mis show_mis"><span class="n"><a href="#t84">84</a></span><span class="t">        <span class="nam">payment_currency</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">user</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">currency_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t85" class="mis show_mis"><span class="n"><a href="#t85">85</a></span><span class="t">        <span class="nam">invoices</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_get_invoices</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t86" class="pln"><span class="n"><a href="#t86">86</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t87" class="mis show_mis"><span class="n"><a href="#t87">87</a></span><span class="t">        <span class="key">if</span> <span class="nam">all</span><span class="op">(</span><span class="nam">inv</span><span class="op">.</span><span class="nam">currency_id</span> <span class="op">==</span> <span class="nam">payment_currency</span> <span class="key">for</span> <span class="nam">inv</span> <span class="key">in</span> <span class="nam">invoices</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t88" class="mis show_mis"><span class="n"><a href="#t88">88</a></span><span class="t">            <span class="nam">total</span> <span class="op">=</span> <span class="nam">sum</span><span class="op">(</span><span class="nam">invoices</span><span class="op">.</span><span class="nam">mapped</span><span class="op">(</span><span class="str">'residual_signed'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t89" class="pln"><span class="n"><a href="#t89">89</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t90" class="mis show_mis"><span class="n"><a href="#t90">90</a></span><span class="t">            <span class="nam">total</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p id="t91" class="mis show_mis"><span class="n"><a href="#t91">91</a></span><span class="t">            <span class="key">for</span> <span class="nam">inv</span> <span class="key">in</span> <span class="nam">invoices</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t92" class="mis show_mis"><span class="n"><a href="#t92">92</a></span><span class="t">                <span class="key">if</span> <span class="nam">inv</span><span class="op">.</span><span class="nam">company_currency_id</span> <span class="op">!=</span> <span class="nam">payment_currency</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t93" class="mis show_mis"><span class="n"><a href="#t93">93</a></span><span class="t">                    <span class="nam">total</span> <span class="op">+=</span> <span class="nam">inv</span><span class="op">.</span><span class="nam">company_currency_id</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">date</span><span class="op">=</span><span class="nam">self</span><span class="op">.</span><span class="nam">payment_date</span><span class="op">)</span><span class="op">.</span><span class="nam">compute</span><span class="op">(</span><span class="nam">inv</span><span class="op">.</span><span class="nam">residual_company_signed</span><span class="op">,</span> <span class="nam">payment_currency</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t94" class="pln"><span class="n"><a href="#t94">94</a></span><span class="t">                <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t95" class="mis show_mis"><span class="n"><a href="#t95">95</a></span><span class="t">                    <span class="nam">total</span> <span class="op">+=</span> <span class="nam">inv</span><span class="op">.</span><span class="nam">residual_company_signed</span>&nbsp;</span><span class="r"></span></p>
    <p id="t96" class="mis show_mis"><span class="n"><a href="#t96">96</a></span><span class="t">        <span class="key">return</span> <span class="nam">abs</span><span class="op">(</span><span class="nam">total</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t97" class="pln"><span class="n"><a href="#t97">97</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t98" class="pln"><span class="n"><a href="#t98">98</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t99" class="run"><span class="n"><a href="#t99">99</a></span><span class="t"><span class="key">class</span> <span class="nam">account_register_payments</span><span class="op">(</span><span class="nam">models</span><span class="op">.</span><span class="nam">TransientModel</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t100" class="run"><span class="n"><a href="#t100">100</a></span><span class="t">    <span class="nam">_name</span> <span class="op">=</span> <span class="str">"account.register.payments"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t101" class="run"><span class="n"><a href="#t101">101</a></span><span class="t">    <span class="nam">_inherit</span> <span class="op">=</span> <span class="str">'account.abstract.payment'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t102" class="run"><span class="n"><a href="#t102">102</a></span><span class="t">    <span class="nam">_description</span> <span class="op">=</span> <span class="str">"Register payments on multiple invoices"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t103" class="pln"><span class="n"><a href="#t103">103</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t104" class="run"><span class="n"><a href="#t104">104</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">onchange</span><span class="op">(</span><span class="str">'payment_type'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t105" class="pln"><span class="n"><a href="#t105">105</a></span><span class="t">    <span class="key">def</span> <span class="nam">_onchange_payment_type</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t106" class="mis show_mis"><span class="n"><a href="#t106">106</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_type</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t107" class="mis show_mis"><span class="n"><a href="#t107">107</a></span><span class="t">            <span class="key">return</span> <span class="op">{</span><span class="str">'domain'</span><span class="op">:</span> <span class="op">{</span><span class="str">'payment_method_id'</span><span class="op">:</span> <span class="op">[</span><span class="op">(</span><span class="str">'payment_type'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_type</span><span class="op">)</span><span class="op">]</span><span class="op">}</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t108" class="pln"><span class="n"><a href="#t108">108</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t109" class="run"><span class="n"><a href="#t109">109</a></span><span class="t">    <span class="key">def</span> <span class="nam">_get_invoices</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t110" class="mis show_mis"><span class="n"><a href="#t110">110</a></span><span class="t">        <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.invoice'</span><span class="op">]</span><span class="op">.</span><span class="nam">browse</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">_context</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'active_ids'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t111" class="pln"><span class="n"><a href="#t111">111</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t112" class="run"><span class="n"><a href="#t112">112</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">model</span>&nbsp;</span><span class="r"></span></p>
    <p id="t113" class="pln"><span class="n"><a href="#t113">113</a></span><span class="t">    <span class="key">def</span> <span class="nam">default_get</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">fields</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t114" class="mis show_mis"><span class="n"><a href="#t114">114</a></span><span class="t">        <span class="nam">rec</span> <span class="op">=</span> <span class="nam">super</span><span class="op">(</span><span class="nam">account_register_payments</span><span class="op">,</span> <span class="nam">self</span><span class="op">)</span><span class="op">.</span><span class="nam">default_get</span><span class="op">(</span><span class="nam">fields</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t115" class="mis show_mis"><span class="n"><a href="#t115">115</a></span><span class="t">        <span class="nam">context</span> <span class="op">=</span> <span class="nam">dict</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">_context</span> <span class="key">or</span> <span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t116" class="mis show_mis"><span class="n"><a href="#t116">116</a></span><span class="t">        <span class="nam">active_model</span> <span class="op">=</span> <span class="nam">context</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'active_model'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t117" class="mis show_mis"><span class="n"><a href="#t117">117</a></span><span class="t">        <span class="nam">active_ids</span> <span class="op">=</span> <span class="nam">context</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'active_ids'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t118" class="pln"><span class="n"><a href="#t118">118</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t119" class="pln"><span class="n"><a href="#t119">119</a></span><span class="t">        <span class="com"># Checks on context parameters</span>&nbsp;</span><span class="r"></span></p>
    <p id="t120" class="mis show_mis"><span class="n"><a href="#t120">120</a></span><span class="t">        <span class="key">if</span> <span class="key">not</span> <span class="nam">active_model</span> <span class="key">or</span> <span class="key">not</span> <span class="nam">active_ids</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t121" class="mis show_mis"><span class="n"><a href="#t121">121</a></span><span class="t">            <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">"Programmation error: wizard action executed without active_model or active_ids in context."</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t122" class="mis show_mis"><span class="n"><a href="#t122">122</a></span><span class="t">        <span class="key">if</span> <span class="nam">active_model</span> <span class="op">!=</span> <span class="str">'account.invoice'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t123" class="mis show_mis"><span class="n"><a href="#t123">123</a></span><span class="t">            <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">"Programmation error: the expected model for this action is 'account.invoice'. The provided one is '%d'."</span><span class="op">)</span> <span class="op">%</span> <span class="nam">active_model</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t124" class="pln"><span class="n"><a href="#t124">124</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t125" class="pln"><span class="n"><a href="#t125">125</a></span><span class="t">        <span class="com"># Checks on received invoice records</span>&nbsp;</span><span class="r"></span></p>
    <p id="t126" class="mis show_mis"><span class="n"><a href="#t126">126</a></span><span class="t">        <span class="nam">invoices</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="nam">active_model</span><span class="op">]</span><span class="op">.</span><span class="nam">browse</span><span class="op">(</span><span class="nam">active_ids</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t127" class="mis show_mis"><span class="n"><a href="#t127">127</a></span><span class="t">        <span class="key">if</span> <span class="nam">any</span><span class="op">(</span><span class="nam">invoice</span><span class="op">.</span><span class="nam">state</span> <span class="op">!=</span> <span class="str">'open'</span> <span class="key">for</span> <span class="nam">invoice</span> <span class="key">in</span> <span class="nam">invoices</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t128" class="mis show_mis"><span class="n"><a href="#t128">128</a></span><span class="t">            <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">"You can only register payments for open invoices"</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t129" class="mis show_mis"><span class="n"><a href="#t129">129</a></span><span class="t">        <span class="key">if</span> <span class="nam">any</span><span class="op">(</span><span class="nam">inv</span><span class="op">.</span><span class="nam">commercial_partner_id</span> <span class="op">!=</span> <span class="nam">invoices</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">commercial_partner_id</span> <span class="key">for</span> <span class="nam">inv</span> <span class="key">in</span> <span class="nam">invoices</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t130" class="mis show_mis"><span class="n"><a href="#t130">130</a></span><span class="t">            <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">"In order to pay multiple invoices at once, they must belong to the same commercial partner."</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t131" class="mis show_mis"><span class="n"><a href="#t131">131</a></span><span class="t">        <span class="key">if</span> <span class="nam">any</span><span class="op">(</span><span class="nam">MAP_INVOICE_TYPE_PARTNER_TYPE</span><span class="op">[</span><span class="nam">inv</span><span class="op">.</span><span class="nam">type</span><span class="op">]</span> <span class="op">!=</span> <span class="nam">MAP_INVOICE_TYPE_PARTNER_TYPE</span><span class="op">[</span><span class="nam">invoices</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">type</span><span class="op">]</span> <span class="key">for</span> <span class="nam">inv</span> <span class="key">in</span> <span class="nam">invoices</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t132" class="mis show_mis"><span class="n"><a href="#t132">132</a></span><span class="t">            <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">"You cannot mix customer invoices and vendor bills in a single payment."</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t133" class="mis show_mis"><span class="n"><a href="#t133">133</a></span><span class="t">        <span class="key">if</span> <span class="nam">any</span><span class="op">(</span><span class="nam">inv</span><span class="op">.</span><span class="nam">currency_id</span> <span class="op">!=</span> <span class="nam">invoices</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">for</span> <span class="nam">inv</span> <span class="key">in</span> <span class="nam">invoices</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t134" class="mis show_mis"><span class="n"><a href="#t134">134</a></span><span class="t">            <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">"In order to pay multiple invoices at once, they must use the same currency."</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t135" class="pln"><span class="n"><a href="#t135">135</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t136" class="mis show_mis"><span class="n"><a href="#t136">136</a></span><span class="t">        <span class="nam">total_amount</span> <span class="op">=</span> <span class="nam">sum</span><span class="op">(</span><span class="nam">inv</span><span class="op">.</span><span class="nam">residual</span> <span class="op">*</span> <span class="nam">MAP_INVOICE_TYPE_PAYMENT_SIGN</span><span class="op">[</span><span class="nam">inv</span><span class="op">.</span><span class="nam">type</span><span class="op">]</span> <span class="key">for</span> <span class="nam">inv</span> <span class="key">in</span> <span class="nam">invoices</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t137" class="mis show_mis"><span class="n"><a href="#t137">137</a></span><span class="t">        <span class="nam">communication</span> <span class="op">=</span> <span class="str">' '</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="op">[</span><span class="nam">ref</span> <span class="key">for</span> <span class="nam">ref</span> <span class="key">in</span> <span class="nam">invoices</span><span class="op">.</span><span class="nam">mapped</span><span class="op">(</span><span class="str">'reference'</span><span class="op">)</span> <span class="key">if</span> <span class="nam">ref</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t138" class="pln"><span class="n"><a href="#t138">138</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t139" class="mis show_mis"><span class="n"><a href="#t139">139</a></span><span class="t">        <span class="nam">rec</span><span class="op">.</span><span class="nam">update</span><span class="op">(</span><span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t140" class="pln"><span class="n"><a href="#t140">140</a></span><span class="t">            <span class="str">'amount'</span><span class="op">:</span> <span class="nam">abs</span><span class="op">(</span><span class="nam">total_amount</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t141" class="pln"><span class="n"><a href="#t141">141</a></span><span class="t">            <span class="str">'currency_id'</span><span class="op">:</span> <span class="nam">invoices</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t142" class="pln"><span class="n"><a href="#t142">142</a></span><span class="t">            <span class="str">'payment_type'</span><span class="op">:</span> <span class="nam">total_amount</span> <span class="op">></span> <span class="num">0</span> <span class="key">and</span> <span class="str">'inbound'</span> <span class="key">or</span> <span class="str">'outbound'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t143" class="pln"><span class="n"><a href="#t143">143</a></span><span class="t">            <span class="str">'partner_id'</span><span class="op">:</span> <span class="nam">invoices</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">commercial_partner_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t144" class="pln"><span class="n"><a href="#t144">144</a></span><span class="t">            <span class="str">'partner_type'</span><span class="op">:</span> <span class="nam">MAP_INVOICE_TYPE_PARTNER_TYPE</span><span class="op">[</span><span class="nam">invoices</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">type</span><span class="op">]</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t145" class="pln"><span class="n"><a href="#t145">145</a></span><span class="t">            <span class="str">'communication'</span><span class="op">:</span> <span class="nam">communication</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t146" class="pln"><span class="n"><a href="#t146">146</a></span><span class="t">        <span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t147" class="mis show_mis"><span class="n"><a href="#t147">147</a></span><span class="t">        <span class="key">return</span> <span class="nam">rec</span>&nbsp;</span><span class="r"></span></p>
    <p id="t148" class="pln"><span class="n"><a href="#t148">148</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t149" class="run"><span class="n"><a href="#t149">149</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_payment_vals</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t150" class="pln"><span class="n"><a href="#t150">150</a></span><span class="t">        <span class="str">""" Hook for extension """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t151" class="mis show_mis"><span class="n"><a href="#t151">151</a></span><span class="t">        <span class="key">return</span> <span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t152" class="pln"><span class="n"><a href="#t152">152</a></span><span class="t">            <span class="str">'journal_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t153" class="pln"><span class="n"><a href="#t153">153</a></span><span class="t">            <span class="str">'payment_method_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_method_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t154" class="pln"><span class="n"><a href="#t154">154</a></span><span class="t">            <span class="str">'payment_date'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_date</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t155" class="pln"><span class="n"><a href="#t155">155</a></span><span class="t">            <span class="str">'communication'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">communication</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t156" class="pln"><span class="n"><a href="#t156">156</a></span><span class="t">            <span class="str">'invoice_ids'</span><span class="op">:</span> <span class="op">[</span><span class="op">(</span><span class="num">4</span><span class="op">,</span> <span class="nam">inv</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">None</span><span class="op">)</span> <span class="key">for</span> <span class="nam">inv</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_get_invoices</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t157" class="pln"><span class="n"><a href="#t157">157</a></span><span class="t">            <span class="str">'payment_type'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_type</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t158" class="pln"><span class="n"><a href="#t158">158</a></span><span class="t">            <span class="str">'amount'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">amount</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t159" class="pln"><span class="n"><a href="#t159">159</a></span><span class="t">            <span class="str">'currency_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t160" class="pln"><span class="n"><a href="#t160">160</a></span><span class="t">            <span class="str">'partner_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t161" class="pln"><span class="n"><a href="#t161">161</a></span><span class="t">            <span class="str">'partner_type'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_type</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t162" class="pln"><span class="n"><a href="#t162">162</a></span><span class="t">        <span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t163" class="pln"><span class="n"><a href="#t163">163</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t164" class="run"><span class="n"><a href="#t164">164</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t165" class="pln"><span class="n"><a href="#t165">165</a></span><span class="t">    <span class="key">def</span> <span class="nam">create_payment</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t166" class="mis show_mis"><span class="n"><a href="#t166">166</a></span><span class="t">        <span class="nam">payment</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.payment'</span><span class="op">]</span><span class="op">.</span><span class="nam">create</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">get_payment_vals</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t167" class="mis show_mis"><span class="n"><a href="#t167">167</a></span><span class="t">        <span class="nam">payment</span><span class="op">.</span><span class="nam">post</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t168" class="mis show_mis"><span class="n"><a href="#t168">168</a></span><span class="t">        <span class="key">return</span> <span class="op">{</span><span class="str">'type'</span><span class="op">:</span> <span class="str">'ir.actions.act_window_close'</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t169" class="pln"><span class="n"><a href="#t169">169</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t170" class="pln"><span class="n"><a href="#t170">170</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t171" class="run"><span class="n"><a href="#t171">171</a></span><span class="t"><span class="key">class</span> <span class="nam">account_payment</span><span class="op">(</span><span class="nam">models</span><span class="op">.</span><span class="nam">Model</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t172" class="run"><span class="n"><a href="#t172">172</a></span><span class="t">    <span class="nam">_name</span> <span class="op">=</span> <span class="str">"account.payment"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t173" class="run"><span class="n"><a href="#t173">173</a></span><span class="t">    <span class="nam">_inherit</span> <span class="op">=</span> <span class="str">'account.abstract.payment'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t174" class="run"><span class="n"><a href="#t174">174</a></span><span class="t">    <span class="nam">_description</span> <span class="op">=</span> <span class="str">"Payments"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t175" class="run"><span class="n"><a href="#t175">175</a></span><span class="t">    <span class="nam">_order</span> <span class="op">=</span> <span class="str">"payment_date desc, name desc"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t176" class="pln"><span class="n"><a href="#t176">176</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t177" class="run"><span class="n"><a href="#t177">177</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">one</span>&nbsp;</span><span class="r"></span></p>
    <p id="t178" class="run"><span class="n"><a href="#t178">178</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">depends</span><span class="op">(</span><span class="str">'invoice_ids'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t179" class="pln"><span class="n"><a href="#t179">179</a></span><span class="t">    <span class="key">def</span> <span class="nam">_get_has_invoices</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t180" class="mis show_mis"><span class="n"><a href="#t180">180</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">has_invoices</span> <span class="op">=</span> <span class="nam">bool</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">invoice_ids</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t181" class="pln"><span class="n"><a href="#t181">181</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t182" class="run"><span class="n"><a href="#t182">182</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">one</span>&nbsp;</span><span class="r"></span></p>
    <p id="t183" class="run"><span class="n"><a href="#t183">183</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">depends</span><span class="op">(</span><span class="str">'invoice_ids'</span><span class="op">,</span> <span class="str">'amount'</span><span class="op">,</span> <span class="str">'payment_date'</span><span class="op">,</span> <span class="str">'currency_id'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t184" class="pln"><span class="n"><a href="#t184">184</a></span><span class="t">    <span class="key">def</span> <span class="nam">_compute_payment_difference</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t185" class="mis show_mis"><span class="n"><a href="#t185">185</a></span><span class="t">        <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">invoice_ids</span><span class="op">)</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t186" class="mis show_mis"><span class="n"><a href="#t186">186</a></span><span class="t">            <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p id="t187" class="mis show_mis"><span class="n"><a href="#t187">187</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">invoice_ids</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">type</span> <span class="key">in</span> <span class="op">[</span><span class="str">'in_invoice'</span><span class="op">,</span> <span class="str">'out_refund'</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t188" class="mis show_mis"><span class="n"><a href="#t188">188</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">payment_difference</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">amount</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_compute_total_invoices_amount</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t189" class="pln"><span class="n"><a href="#t189">189</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t190" class="mis show_mis"><span class="n"><a href="#t190">190</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">payment_difference</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_compute_total_invoices_amount</span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">amount</span>&nbsp;</span><span class="r"></span></p>
    <p id="t191" class="pln"><span class="n"><a href="#t191">191</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t192" class="run"><span class="n"><a href="#t192">192</a></span><span class="t">    <span class="nam">company_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="nam">store</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t193" class="pln"><span class="n"><a href="#t193">193</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t194" class="run"><span class="n"><a href="#t194">194</a></span><span class="t">    <span class="nam">name</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Char</span><span class="op">(</span><span class="nam">readonly</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">copy</span><span class="op">=</span><span class="nam">False</span><span class="op">,</span> <span class="nam">default</span><span class="op">=</span><span class="str">"Draft Payment"</span><span class="op">)</span> <span class="com"># The name is attributed upon post()</span>&nbsp;</span><span class="r"></span></p>
    <p id="t195" class="run"><span class="n"><a href="#t195">195</a></span><span class="t">    <span class="nam">state</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Selection</span><span class="op">(</span><span class="op">[</span><span class="op">(</span><span class="str">'draft'</span><span class="op">,</span> <span class="str">'Draft'</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="str">'posted'</span><span class="op">,</span> <span class="str">'Posted'</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="str">'sent'</span><span class="op">,</span> <span class="str">'Sent'</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="str">'reconciled'</span><span class="op">,</span> <span class="str">'Reconciled'</span><span class="op">)</span><span class="op">]</span><span class="op">,</span> <span class="nam">readonly</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">default</span><span class="op">=</span><span class="str">'draft'</span><span class="op">,</span> <span class="nam">copy</span><span class="op">=</span><span class="nam">False</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">"Status"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t196" class="pln"><span class="n"><a href="#t196">196</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t197" class="run"><span class="n"><a href="#t197">197</a></span><span class="t">    <span class="nam">payment_type</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Selection</span><span class="op">(</span><span class="nam">selection_add</span><span class="op">=</span><span class="op">[</span><span class="op">(</span><span class="str">'transfer'</span><span class="op">,</span> <span class="str">'Internal Transfer'</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t198" class="run"><span class="n"><a href="#t198">198</a></span><span class="t">    <span class="nam">payment_reference</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Char</span><span class="op">(</span><span class="nam">copy</span><span class="op">=</span><span class="nam">False</span><span class="op">,</span> <span class="nam">readonly</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">help</span><span class="op">=</span><span class="str">"Reference of the document used to issue this payment. Eg. check number, file name, etc."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t199" class="run"><span class="n"><a href="#t199">199</a></span><span class="t">    <span class="nam">move_name</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Char</span><span class="op">(</span><span class="nam">string</span><span class="op">=</span><span class="str">'Journal Entry Name'</span><span class="op">,</span> <span class="nam">readonly</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t200" class="pln"><span class="n"><a href="#t200">200</a></span><span class="t">        <span class="nam">default</span><span class="op">=</span><span class="nam">False</span><span class="op">,</span> <span class="nam">copy</span><span class="op">=</span><span class="nam">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t201" class="pln"><span class="n"><a href="#t201">201</a></span><span class="t">        <span class="nam">help</span><span class="op">=</span><span class="str">"Technical field holding the number given to the journal entry, automatically set when the statement line is reconciled then stored to set the same number again if the line is cancelled, set to draft and re-processed again."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t202" class="pln"><span class="n"><a href="#t202">202</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t203" class="pln"><span class="n"><a href="#t203">203</a></span><span class="t">    <span class="com"># Money flows from the journal_id's default_debit_account_id or default_credit_account_id to the destination_account_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t204" class="run"><span class="n"><a href="#t204">204</a></span><span class="t">    <span class="nam">destination_account_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'account.account'</span><span class="op">,</span> <span class="nam">compute</span><span class="op">=</span><span class="str">'_compute_destination_account_id'</span><span class="op">,</span> <span class="nam">readonly</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t205" class="pln"><span class="n"><a href="#t205">205</a></span><span class="t">    <span class="com"># For money transfer, money goes from journal_id to a transfer account, then from the transfer account to destination_journal_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t206" class="run"><span class="n"><a href="#t206">206</a></span><span class="t">    <span class="nam">destination_journal_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'account.journal'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Transfer To'</span><span class="op">,</span> <span class="nam">domain</span><span class="op">=</span><span class="op">[</span><span class="op">(</span><span class="str">'type'</span><span class="op">,</span> <span class="str">'in'</span><span class="op">,</span> <span class="op">(</span><span class="str">'bank'</span><span class="op">,</span> <span class="str">'cash'</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t207" class="pln"><span class="n"><a href="#t207">207</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t208" class="run"><span class="n"><a href="#t208">208</a></span><span class="t">    <span class="nam">invoice_ids</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2many</span><span class="op">(</span><span class="str">'account.invoice'</span><span class="op">,</span> <span class="str">'account_invoice_payment_rel'</span><span class="op">,</span> <span class="str">'payment_id'</span><span class="op">,</span> <span class="str">'invoice_id'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">"Invoices"</span><span class="op">,</span> <span class="nam">copy</span><span class="op">=</span><span class="nam">False</span><span class="op">,</span> <span class="nam">readonly</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t209" class="run"><span class="n"><a href="#t209">209</a></span><span class="t">    <span class="nam">has_invoices</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Boolean</span><span class="op">(</span><span class="nam">compute</span><span class="op">=</span><span class="str">"_get_has_invoices"</span><span class="op">,</span> <span class="nam">help</span><span class="op">=</span><span class="str">"Technical field used for usability purposes"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t210" class="run"><span class="n"><a href="#t210">210</a></span><span class="t">    <span class="nam">payment_difference</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Monetary</span><span class="op">(</span><span class="nam">compute</span><span class="op">=</span><span class="str">'_compute_payment_difference'</span><span class="op">,</span> <span class="nam">readonly</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t211" class="run"><span class="n"><a href="#t211">211</a></span><span class="t">    <span class="nam">payment_difference_handling</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Selection</span><span class="op">(</span><span class="op">[</span><span class="op">(</span><span class="str">'open'</span><span class="op">,</span> <span class="str">'Keep open'</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="str">'reconcile'</span><span class="op">,</span> <span class="str">'Mark invoice as fully paid'</span><span class="op">)</span><span class="op">]</span><span class="op">,</span> <span class="nam">default</span><span class="op">=</span><span class="str">'open'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">"Payment Difference"</span><span class="op">,</span> <span class="nam">copy</span><span class="op">=</span><span class="nam">False</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t212" class="run"><span class="n"><a href="#t212">212</a></span><span class="t">    <span class="nam">writeoff_account_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'account.account'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">"Difference Account"</span><span class="op">,</span> <span class="nam">domain</span><span class="op">=</span><span class="op">[</span><span class="op">(</span><span class="str">'deprecated'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="nam">False</span><span class="op">)</span><span class="op">]</span><span class="op">,</span> <span class="nam">copy</span><span class="op">=</span><span class="nam">False</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t213" class="pln"><span class="n"><a href="#t213">213</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t214" class="pln"><span class="n"><a href="#t214">214</a></span><span class="t">    <span class="com"># FIXME: ondelete='restrict' not working (eg. cancel a bank statement reconciliation with a payment)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t215" class="run"><span class="n"><a href="#t215">215</a></span><span class="t">    <span class="nam">move_line_ids</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">One2many</span><span class="op">(</span><span class="str">'account.move.line'</span><span class="op">,</span> <span class="str">'payment_id'</span><span class="op">,</span> <span class="nam">readonly</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">copy</span><span class="op">=</span><span class="nam">False</span><span class="op">,</span> <span class="nam">ondelete</span><span class="op">=</span><span class="str">'restrict'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t216" class="pln"><span class="n"><a href="#t216">216</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t217" class="run"><span class="n"><a href="#t217">217</a></span><span class="t">    <span class="key">def</span> <span class="nam">open_payment_matching_screen</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t218" class="pln"><span class="n"><a href="#t218">218</a></span><span class="t">        <span class="com"># Open reconciliation view for customers/suppliers</span>&nbsp;</span><span class="r"></span></p>
    <p id="t219" class="mis show_mis"><span class="n"><a href="#t219">219</a></span><span class="t">        <span class="nam">action_context</span> <span class="op">=</span> <span class="op">{</span><span class="str">'company_ids'</span><span class="op">:</span> <span class="op">[</span><span class="nam">self</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">,</span> <span class="str">'partner_ids'</span><span class="op">:</span> <span class="op">[</span><span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">.</span><span class="nam">commercial_partner_id</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t220" class="mis show_mis"><span class="n"><a href="#t220">220</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_type</span> <span class="op">==</span> <span class="str">'customer'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t221" class="mis show_mis"><span class="n"><a href="#t221">221</a></span><span class="t">            <span class="nam">action_context</span><span class="op">.</span><span class="nam">update</span><span class="op">(</span><span class="op">{</span><span class="str">'mode'</span><span class="op">:</span> <span class="str">'customers'</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t222" class="mis show_mis"><span class="n"><a href="#t222">222</a></span><span class="t">        <span class="key">elif</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_type</span> <span class="op">==</span> <span class="str">'supplier'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t223" class="mis show_mis"><span class="n"><a href="#t223">223</a></span><span class="t">            <span class="nam">action_context</span><span class="op">.</span><span class="nam">update</span><span class="op">(</span><span class="op">{</span><span class="str">'mode'</span><span class="op">:</span> <span class="str">'suppliers'</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t224" class="mis show_mis"><span class="n"><a href="#t224">224</a></span><span class="t">        <span class="key">return</span> <span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t225" class="pln"><span class="n"><a href="#t225">225</a></span><span class="t">            <span class="str">'type'</span><span class="op">:</span> <span class="str">'ir.actions.client'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t226" class="pln"><span class="n"><a href="#t226">226</a></span><span class="t">            <span class="str">'tag'</span><span class="op">:</span> <span class="str">'manual_reconciliation_view'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t227" class="pln"><span class="n"><a href="#t227">227</a></span><span class="t">            <span class="str">'context'</span><span class="op">:</span> <span class="nam">action_context</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t228" class="pln"><span class="n"><a href="#t228">228</a></span><span class="t">        <span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t229" class="pln"><span class="n"><a href="#t229">229</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t230" class="run"><span class="n"><a href="#t230">230</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">one</span>&nbsp;</span><span class="r"></span></p>
    <p id="t231" class="run"><span class="n"><a href="#t231">231</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">depends</span><span class="op">(</span><span class="str">'invoice_ids'</span><span class="op">,</span> <span class="str">'payment_type'</span><span class="op">,</span> <span class="str">'partner_type'</span><span class="op">,</span> <span class="str">'partner_id'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t232" class="pln"><span class="n"><a href="#t232">232</a></span><span class="t">    <span class="key">def</span> <span class="nam">_compute_destination_account_id</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t233" class="mis show_mis"><span class="n"><a href="#t233">233</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">invoice_ids</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t234" class="mis show_mis"><span class="n"><a href="#t234">234</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">destination_account_id</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">invoice_ids</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">account_id</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t235" class="mis show_mis"><span class="n"><a href="#t235">235</a></span><span class="t">        <span class="key">elif</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_type</span> <span class="op">==</span> <span class="str">'transfer'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t236" class="mis show_mis"><span class="n"><a href="#t236">236</a></span><span class="t">            <span class="key">if</span> <span class="key">not</span> <span class="nam">self</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">transfer_account_id</span><span class="op">.</span><span class="nam">id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t237" class="mis show_mis"><span class="n"><a href="#t237">237</a></span><span class="t">                <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'Transfer account not defined on the company.'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t238" class="mis show_mis"><span class="n"><a href="#t238">238</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">destination_account_id</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">transfer_account_id</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t239" class="mis show_mis"><span class="n"><a href="#t239">239</a></span><span class="t">        <span class="key">elif</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t240" class="mis show_mis"><span class="n"><a href="#t240">240</a></span><span class="t">            <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_type</span> <span class="op">==</span> <span class="str">'customer'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t241" class="mis show_mis"><span class="n"><a href="#t241">241</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">destination_account_id</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">.</span><span class="nam">property_account_receivable_id</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t242" class="pln"><span class="n"><a href="#t242">242</a></span><span class="t">            <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t243" class="mis show_mis"><span class="n"><a href="#t243">243</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">destination_account_id</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">.</span><span class="nam">property_account_payable_id</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t244" class="pln"><span class="n"><a href="#t244">244</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t245" class="run"><span class="n"><a href="#t245">245</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">onchange</span><span class="op">(</span><span class="str">'partner_type'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t246" class="pln"><span class="n"><a href="#t246">246</a></span><span class="t">    <span class="key">def</span> <span class="nam">_onchange_partner_type</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t247" class="pln"><span class="n"><a href="#t247">247</a></span><span class="t">        <span class="com"># Set partner_id domain</span>&nbsp;</span><span class="r"></span></p>
    <p id="t248" class="mis show_mis"><span class="n"><a href="#t248">248</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_type</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t249" class="mis show_mis"><span class="n"><a href="#t249">249</a></span><span class="t">            <span class="key">return</span> <span class="op">{</span><span class="str">'domain'</span><span class="op">:</span> <span class="op">{</span><span class="str">'partner_id'</span><span class="op">:</span> <span class="op">[</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">partner_type</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="nam">True</span><span class="op">)</span><span class="op">]</span><span class="op">}</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t250" class="pln"><span class="n"><a href="#t250">250</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t251" class="run"><span class="n"><a href="#t251">251</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">onchange</span><span class="op">(</span><span class="str">'payment_type'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t252" class="pln"><span class="n"><a href="#t252">252</a></span><span class="t">    <span class="key">def</span> <span class="nam">_onchange_payment_type</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t253" class="mis show_mis"><span class="n"><a href="#t253">253</a></span><span class="t">        <span class="key">if</span> <span class="key">not</span> <span class="nam">self</span><span class="op">.</span><span class="nam">invoice_ids</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t254" class="pln"><span class="n"><a href="#t254">254</a></span><span class="t">            <span class="com"># Set default partner type for the payment type</span>&nbsp;</span><span class="r"></span></p>
    <p id="t255" class="mis show_mis"><span class="n"><a href="#t255">255</a></span><span class="t">            <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_type</span> <span class="op">==</span> <span class="str">'inbound'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t256" class="mis show_mis"><span class="n"><a href="#t256">256</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">partner_type</span> <span class="op">=</span> <span class="str">'customer'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t257" class="mis show_mis"><span class="n"><a href="#t257">257</a></span><span class="t">            <span class="key">elif</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_type</span> <span class="op">==</span> <span class="str">'outbound'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t258" class="mis show_mis"><span class="n"><a href="#t258">258</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">partner_type</span> <span class="op">=</span> <span class="str">'supplier'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t259" class="pln"><span class="n"><a href="#t259">259</a></span><span class="t">            <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t260" class="mis show_mis"><span class="n"><a href="#t260">260</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">partner_type</span> <span class="op">=</span> <span class="nam">False</span>&nbsp;</span><span class="r"></span></p>
    <p id="t261" class="pln"><span class="n"><a href="#t261">261</a></span><span class="t">        <span class="com"># Set payment method domain</span>&nbsp;</span><span class="r"></span></p>
    <p id="t262" class="mis show_mis"><span class="n"><a href="#t262">262</a></span><span class="t">        <span class="nam">res</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_onchange_journal</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t263" class="mis show_mis"><span class="n"><a href="#t263">263</a></span><span class="t">        <span class="key">if</span> <span class="key">not</span> <span class="nam">res</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'domain'</span><span class="op">,</span> <span class="op">{</span><span class="op">}</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t264" class="mis show_mis"><span class="n"><a href="#t264">264</a></span><span class="t">            <span class="nam">res</span><span class="op">[</span><span class="str">'domain'</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t265" class="mis show_mis"><span class="n"><a href="#t265">265</a></span><span class="t">        <span class="nam">res</span><span class="op">[</span><span class="str">'domain'</span><span class="op">]</span><span class="op">[</span><span class="str">'journal_id'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_type</span> <span class="op">==</span> <span class="str">'inbound'</span> <span class="key">and</span> <span class="op">[</span><span class="op">(</span><span class="str">'at_least_one_inbound'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="nam">True</span><span class="op">)</span><span class="op">]</span> <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_type</span> <span class="op">==</span> <span class="str">'outbound'</span> <span class="key">and</span> <span class="op">[</span><span class="op">(</span><span class="str">'at_least_one_outbound'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="nam">True</span><span class="op">)</span><span class="op">]</span> <span class="key">or</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t266" class="mis show_mis"><span class="n"><a href="#t266">266</a></span><span class="t">        <span class="nam">res</span><span class="op">[</span><span class="str">'domain'</span><span class="op">]</span><span class="op">[</span><span class="str">'journal_id'</span><span class="op">]</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="op">(</span><span class="str">'type'</span><span class="op">,</span> <span class="str">'in'</span><span class="op">,</span> <span class="op">(</span><span class="str">'bank'</span><span class="op">,</span> <span class="str">'cash'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t267" class="mis show_mis"><span class="n"><a href="#t267">267</a></span><span class="t">        <span class="key">return</span> <span class="nam">res</span>&nbsp;</span><span class="r"></span></p>
    <p id="t268" class="pln"><span class="n"><a href="#t268">268</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t269" class="run"><span class="n"><a href="#t269">269</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">model</span>&nbsp;</span><span class="r"></span></p>
    <p id="t270" class="pln"><span class="n"><a href="#t270">270</a></span><span class="t">    <span class="key">def</span> <span class="nam">default_get</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">fields</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t271" class="mis show_mis"><span class="n"><a href="#t271">271</a></span><span class="t">        <span class="nam">rec</span> <span class="op">=</span> <span class="nam">super</span><span class="op">(</span><span class="nam">account_payment</span><span class="op">,</span> <span class="nam">self</span><span class="op">)</span><span class="op">.</span><span class="nam">default_get</span><span class="op">(</span><span class="nam">fields</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t272" class="mis show_mis"><span class="n"><a href="#t272">272</a></span><span class="t">        <span class="nam">invoice_defaults</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">resolve_2many_commands</span><span class="op">(</span><span class="str">'invoice_ids'</span><span class="op">,</span> <span class="nam">rec</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'invoice_ids'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t273" class="mis show_mis"><span class="n"><a href="#t273">273</a></span><span class="t">        <span class="key">if</span> <span class="nam">invoice_defaults</span> <span class="key">and</span> <span class="nam">len</span><span class="op">(</span><span class="nam">invoice_defaults</span><span class="op">)</span> <span class="op">==</span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t274" class="mis show_mis"><span class="n"><a href="#t274">274</a></span><span class="t">            <span class="nam">invoice</span> <span class="op">=</span> <span class="nam">invoice_defaults</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t275" class="mis show_mis"><span class="n"><a href="#t275">275</a></span><span class="t">            <span class="nam">rec</span><span class="op">[</span><span class="str">'communication'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">invoice</span><span class="op">[</span><span class="str">'reference'</span><span class="op">]</span> <span class="key">or</span> <span class="nam">invoice</span><span class="op">[</span><span class="str">'name'</span><span class="op">]</span> <span class="key">or</span> <span class="nam">invoice</span><span class="op">[</span><span class="str">'number'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t276" class="mis show_mis"><span class="n"><a href="#t276">276</a></span><span class="t">            <span class="nam">rec</span><span class="op">[</span><span class="str">'currency_id'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">invoice</span><span class="op">[</span><span class="str">'currency_id'</span><span class="op">]</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t277" class="mis show_mis"><span class="n"><a href="#t277">277</a></span><span class="t">            <span class="nam">rec</span><span class="op">[</span><span class="str">'payment_type'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">invoice</span><span class="op">[</span><span class="str">'type'</span><span class="op">]</span> <span class="key">in</span> <span class="op">(</span><span class="str">'out_invoice'</span><span class="op">,</span> <span class="str">'in_refund'</span><span class="op">)</span> <span class="key">and</span> <span class="str">'inbound'</span> <span class="key">or</span> <span class="str">'outbound'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t278" class="mis show_mis"><span class="n"><a href="#t278">278</a></span><span class="t">            <span class="nam">rec</span><span class="op">[</span><span class="str">'partner_type'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">MAP_INVOICE_TYPE_PARTNER_TYPE</span><span class="op">[</span><span class="nam">invoice</span><span class="op">[</span><span class="str">'type'</span><span class="op">]</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t279" class="mis show_mis"><span class="n"><a href="#t279">279</a></span><span class="t">            <span class="nam">rec</span><span class="op">[</span><span class="str">'partner_id'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">invoice</span><span class="op">[</span><span class="str">'partner_id'</span><span class="op">]</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t280" class="mis show_mis"><span class="n"><a href="#t280">280</a></span><span class="t">            <span class="nam">rec</span><span class="op">[</span><span class="str">'amount'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">invoice</span><span class="op">[</span><span class="str">'residual'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t281" class="mis show_mis"><span class="n"><a href="#t281">281</a></span><span class="t">        <span class="key">return</span> <span class="nam">rec</span>&nbsp;</span><span class="r"></span></p>
    <p id="t282" class="pln"><span class="n"><a href="#t282">282</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t283" class="run"><span class="n"><a href="#t283">283</a></span><span class="t">    <span class="key">def</span> <span class="nam">_get_invoices</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t284" class="mis show_mis"><span class="n"><a href="#t284">284</a></span><span class="t">        <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">invoice_ids</span>&nbsp;</span><span class="r"></span></p>
    <p id="t285" class="pln"><span class="n"><a href="#t285">285</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t286" class="run"><span class="n"><a href="#t286">286</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t287" class="pln"><span class="n"><a href="#t287">287</a></span><span class="t">    <span class="key">def</span> <span class="nam">button_journal_entries</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t288" class="mis show_mis"><span class="n"><a href="#t288">288</a></span><span class="t">        <span class="key">return</span> <span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t289" class="pln"><span class="n"><a href="#t289">289</a></span><span class="t">            <span class="str">'name'</span><span class="op">:</span> <span class="nam">_</span><span class="op">(</span><span class="str">'Journal Items'</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t290" class="pln"><span class="n"><a href="#t290">290</a></span><span class="t">            <span class="str">'view_type'</span><span class="op">:</span> <span class="str">'form'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t291" class="pln"><span class="n"><a href="#t291">291</a></span><span class="t">            <span class="str">'view_mode'</span><span class="op">:</span> <span class="str">'tree,form'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t292" class="pln"><span class="n"><a href="#t292">292</a></span><span class="t">            <span class="str">'res_model'</span><span class="op">:</span> <span class="str">'account.move.line'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t293" class="pln"><span class="n"><a href="#t293">293</a></span><span class="t">            <span class="str">'view_id'</span><span class="op">:</span> <span class="nam">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t294" class="pln"><span class="n"><a href="#t294">294</a></span><span class="t">            <span class="str">'type'</span><span class="op">:</span> <span class="str">'ir.actions.act_window'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t295" class="pln"><span class="n"><a href="#t295">295</a></span><span class="t">            <span class="str">'domain'</span><span class="op">:</span> <span class="op">[</span><span class="op">(</span><span class="str">'payment_id'</span><span class="op">,</span> <span class="str">'in'</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">ids</span><span class="op">)</span><span class="op">]</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t296" class="pln"><span class="n"><a href="#t296">296</a></span><span class="t">        <span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t297" class="pln"><span class="n"><a href="#t297">297</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t298" class="run"><span class="n"><a href="#t298">298</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t299" class="pln"><span class="n"><a href="#t299">299</a></span><span class="t">    <span class="key">def</span> <span class="nam">button_invoices</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t300" class="mis show_mis"><span class="n"><a href="#t300">300</a></span><span class="t">        <span class="key">return</span> <span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t301" class="pln"><span class="n"><a href="#t301">301</a></span><span class="t">            <span class="str">'name'</span><span class="op">:</span> <span class="nam">_</span><span class="op">(</span><span class="str">'Paid Invoices'</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t302" class="pln"><span class="n"><a href="#t302">302</a></span><span class="t">            <span class="str">'view_type'</span><span class="op">:</span> <span class="str">'form'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t303" class="pln"><span class="n"><a href="#t303">303</a></span><span class="t">            <span class="str">'view_mode'</span><span class="op">:</span> <span class="str">'tree,form'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t304" class="pln"><span class="n"><a href="#t304">304</a></span><span class="t">            <span class="str">'res_model'</span><span class="op">:</span> <span class="str">'account.invoice'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t305" class="pln"><span class="n"><a href="#t305">305</a></span><span class="t">            <span class="str">'view_id'</span><span class="op">:</span> <span class="nam">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t306" class="pln"><span class="n"><a href="#t306">306</a></span><span class="t">            <span class="str">'type'</span><span class="op">:</span> <span class="str">'ir.actions.act_window'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t307" class="pln"><span class="n"><a href="#t307">307</a></span><span class="t">            <span class="str">'domain'</span><span class="op">:</span> <span class="op">[</span><span class="op">(</span><span class="str">'id'</span><span class="op">,</span> <span class="str">'in'</span><span class="op">,</span> <span class="op">[</span><span class="nam">x</span><span class="op">.</span><span class="nam">id</span> <span class="key">for</span> <span class="nam">x</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">invoice_ids</span><span class="op">]</span><span class="op">)</span><span class="op">]</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t308" class="pln"><span class="n"><a href="#t308">308</a></span><span class="t">        <span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t309" class="pln"><span class="n"><a href="#t309">309</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t310" class="run"><span class="n"><a href="#t310">310</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t311" class="pln"><span class="n"><a href="#t311">311</a></span><span class="t">    <span class="key">def</span> <span class="nam">button_dummy</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t312" class="mis show_mis"><span class="n"><a href="#t312">312</a></span><span class="t">        <span class="key">return</span> <span class="nam">True</span>&nbsp;</span><span class="r"></span></p>
    <p id="t313" class="pln"><span class="n"><a href="#t313">313</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t314" class="run"><span class="n"><a href="#t314">314</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t315" class="pln"><span class="n"><a href="#t315">315</a></span><span class="t">    <span class="key">def</span> <span class="nam">unreconcile</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t316" class="pln"><span class="n"><a href="#t316">316</a></span><span class="t">        <span class="str">""" Set back the payments in 'posted' or 'sent' state, without deleting the journal entries.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t317" class="pln"><span class="n"><a href="#t317">317</a></span><span class="t"><span class="str">            Called when cancelling a bank statement line linked to a pre-registered payment.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t318" class="pln"><span class="n"><a href="#t318">318</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t319" class="mis show_mis"><span class="n"><a href="#t319">319</a></span><span class="t">        <span class="key">for</span> <span class="nam">payment</span> <span class="key">in</span> <span class="nam">self</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t320" class="mis show_mis"><span class="n"><a href="#t320">320</a></span><span class="t">            <span class="key">if</span> <span class="nam">payment</span><span class="op">.</span><span class="nam">payment_reference</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t321" class="mis show_mis"><span class="n"><a href="#t321">321</a></span><span class="t">                <span class="nam">payment</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="op">{</span><span class="str">'state'</span><span class="op">:</span> <span class="str">'sent'</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t322" class="pln"><span class="n"><a href="#t322">322</a></span><span class="t">            <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t323" class="mis show_mis"><span class="n"><a href="#t323">323</a></span><span class="t">                <span class="nam">payment</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="op">{</span><span class="str">'state'</span><span class="op">:</span> <span class="str">'posted'</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t324" class="pln"><span class="n"><a href="#t324">324</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t325" class="run"><span class="n"><a href="#t325">325</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t326" class="pln"><span class="n"><a href="#t326">326</a></span><span class="t">    <span class="key">def</span> <span class="nam">cancel</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t327" class="mis show_mis"><span class="n"><a href="#t327">327</a></span><span class="t">        <span class="key">for</span> <span class="nam">rec</span> <span class="key">in</span> <span class="nam">self</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t328" class="mis show_mis"><span class="n"><a href="#t328">328</a></span><span class="t">            <span class="key">for</span> <span class="nam">move</span> <span class="key">in</span> <span class="nam">rec</span><span class="op">.</span><span class="nam">move_line_ids</span><span class="op">.</span><span class="nam">mapped</span><span class="op">(</span><span class="str">'move_id'</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t329" class="mis show_mis"><span class="n"><a href="#t329">329</a></span><span class="t">                <span class="key">if</span> <span class="nam">rec</span><span class="op">.</span><span class="nam">invoice_ids</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t330" class="mis show_mis"><span class="n"><a href="#t330">330</a></span><span class="t">                    <span class="nam">move</span><span class="op">.</span><span class="nam">line_ids</span><span class="op">.</span><span class="nam">remove_move_reconcile</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t331" class="mis show_mis"><span class="n"><a href="#t331">331</a></span><span class="t">                <span class="nam">move</span><span class="op">.</span><span class="nam">button_cancel</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t332" class="mis show_mis"><span class="n"><a href="#t332">332</a></span><span class="t">                <span class="nam">move</span><span class="op">.</span><span class="nam">unlink</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t333" class="mis show_mis"><span class="n"><a href="#t333">333</a></span><span class="t">            <span class="nam">rec</span><span class="op">.</span><span class="nam">state</span> <span class="op">=</span> <span class="str">'draft'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t334" class="pln"><span class="n"><a href="#t334">334</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t335" class="run"><span class="n"><a href="#t335">335</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t336" class="pln"><span class="n"><a href="#t336">336</a></span><span class="t">    <span class="key">def</span> <span class="nam">unlink</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t337" class="mis show_mis"><span class="n"><a href="#t337">337</a></span><span class="t">        <span class="key">if</span> <span class="nam">any</span><span class="op">(</span><span class="nam">bool</span><span class="op">(</span><span class="nam">rec</span><span class="op">.</span><span class="nam">move_line_ids</span><span class="op">)</span> <span class="key">for</span> <span class="nam">rec</span> <span class="key">in</span> <span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t338" class="mis show_mis"><span class="n"><a href="#t338">338</a></span><span class="t">            <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">"You can not delete a payment that is already posted"</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t339" class="mis show_mis"><span class="n"><a href="#t339">339</a></span><span class="t">        <span class="key">if</span> <span class="nam">any</span><span class="op">(</span><span class="nam">rec</span><span class="op">.</span><span class="nam">move_name</span> <span class="key">for</span> <span class="nam">rec</span> <span class="key">in</span> <span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t340" class="mis show_mis"><span class="n"><a href="#t340">340</a></span><span class="t">            <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'It is not allowed to delete a payment that already created a journal entry since it would create a gap in the numbering. You should create the journal entry again and cancel it thanks to a regular revert.'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t341" class="mis show_mis"><span class="n"><a href="#t341">341</a></span><span class="t">        <span class="key">return</span> <span class="nam">super</span><span class="op">(</span><span class="nam">account_payment</span><span class="op">,</span> <span class="nam">self</span><span class="op">)</span><span class="op">.</span><span class="nam">unlink</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t342" class="pln"><span class="n"><a href="#t342">342</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t343" class="run"><span class="n"><a href="#t343">343</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t344" class="pln"><span class="n"><a href="#t344">344</a></span><span class="t">    <span class="key">def</span> <span class="nam">post</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t345" class="pln"><span class="n"><a href="#t345">345</a></span><span class="t">        <span class="str">""" Create the journal items for the payment and update the payment's state to 'posted'.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t346" class="pln"><span class="n"><a href="#t346">346</a></span><span class="t"><span class="str">            A journal entry is created containing an item in the source liquidity account (selected journal's default_debit or default_credit)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t347" class="pln"><span class="n"><a href="#t347">347</a></span><span class="t"><span class="str">            and another in the destination reconciliable account (see _compute_destination_account_id).</span>&nbsp;</span><span class="r"></span></p>
    <p id="t348" class="pln"><span class="n"><a href="#t348">348</a></span><span class="t"><span class="str">            If invoice_ids is not empty, there will be one reconciliable move line per invoice to reconcile with.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t349" class="pln"><span class="n"><a href="#t349">349</a></span><span class="t"><span class="str">            If the payment is a transfer, a second journal entry is created in the destination journal to receive money from the transfer account.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t350" class="pln"><span class="n"><a href="#t350">350</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t351" class="mis show_mis"><span class="n"><a href="#t351">351</a></span><span class="t">        <span class="key">for</span> <span class="nam">rec</span> <span class="key">in</span> <span class="nam">self</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t352" class="pln"><span class="n"><a href="#t352">352</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t353" class="mis show_mis"><span class="n"><a href="#t353">353</a></span><span class="t">            <span class="key">if</span> <span class="nam">rec</span><span class="op">.</span><span class="nam">state</span> <span class="op">!=</span> <span class="str">'draft'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t354" class="mis show_mis"><span class="n"><a href="#t354">354</a></span><span class="t">                <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">"Only a draft payment can be posted. Trying to post a payment in state %s."</span><span class="op">)</span> <span class="op">%</span> <span class="nam">rec</span><span class="op">.</span><span class="nam">state</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t355" class="pln"><span class="n"><a href="#t355">355</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t356" class="mis show_mis"><span class="n"><a href="#t356">356</a></span><span class="t">            <span class="key">if</span> <span class="nam">any</span><span class="op">(</span><span class="nam">inv</span><span class="op">.</span><span class="nam">state</span> <span class="op">!=</span> <span class="str">'open'</span> <span class="key">for</span> <span class="nam">inv</span> <span class="key">in</span> <span class="nam">rec</span><span class="op">.</span><span class="nam">invoice_ids</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t357" class="mis show_mis"><span class="n"><a href="#t357">357</a></span><span class="t">                <span class="key">raise</span> <span class="nam">ValidationError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">"The payment cannot be processed because the invoice is not open!"</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t358" class="pln"><span class="n"><a href="#t358">358</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t359" class="pln"><span class="n"><a href="#t359">359</a></span><span class="t">            <span class="com"># Use the right sequence to set the name</span>&nbsp;</span><span class="r"></span></p>
    <p id="t360" class="mis show_mis"><span class="n"><a href="#t360">360</a></span><span class="t">            <span class="key">if</span> <span class="nam">rec</span><span class="op">.</span><span class="nam">payment_type</span> <span class="op">==</span> <span class="str">'transfer'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t361" class="mis show_mis"><span class="n"><a href="#t361">361</a></span><span class="t">                <span class="nam">sequence_code</span> <span class="op">=</span> <span class="str">'account.payment.transfer'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t362" class="pln"><span class="n"><a href="#t362">362</a></span><span class="t">            <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t363" class="mis show_mis"><span class="n"><a href="#t363">363</a></span><span class="t">                <span class="key">if</span> <span class="nam">rec</span><span class="op">.</span><span class="nam">partner_type</span> <span class="op">==</span> <span class="str">'customer'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t364" class="mis show_mis"><span class="n"><a href="#t364">364</a></span><span class="t">                    <span class="key">if</span> <span class="nam">rec</span><span class="op">.</span><span class="nam">payment_type</span> <span class="op">==</span> <span class="str">'inbound'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t365" class="mis show_mis"><span class="n"><a href="#t365">365</a></span><span class="t">                        <span class="nam">sequence_code</span> <span class="op">=</span> <span class="str">'account.payment.customer.invoice'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t366" class="mis show_mis"><span class="n"><a href="#t366">366</a></span><span class="t">                    <span class="key">if</span> <span class="nam">rec</span><span class="op">.</span><span class="nam">payment_type</span> <span class="op">==</span> <span class="str">'outbound'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t367" class="mis show_mis"><span class="n"><a href="#t367">367</a></span><span class="t">                        <span class="nam">sequence_code</span> <span class="op">=</span> <span class="str">'account.payment.customer.refund'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t368" class="mis show_mis"><span class="n"><a href="#t368">368</a></span><span class="t">                <span class="key">if</span> <span class="nam">rec</span><span class="op">.</span><span class="nam">partner_type</span> <span class="op">==</span> <span class="str">'supplier'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t369" class="mis show_mis"><span class="n"><a href="#t369">369</a></span><span class="t">                    <span class="key">if</span> <span class="nam">rec</span><span class="op">.</span><span class="nam">payment_type</span> <span class="op">==</span> <span class="str">'inbound'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t370" class="mis show_mis"><span class="n"><a href="#t370">370</a></span><span class="t">                        <span class="nam">sequence_code</span> <span class="op">=</span> <span class="str">'account.payment.supplier.refund'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t371" class="mis show_mis"><span class="n"><a href="#t371">371</a></span><span class="t">                    <span class="key">if</span> <span class="nam">rec</span><span class="op">.</span><span class="nam">payment_type</span> <span class="op">==</span> <span class="str">'outbound'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t372" class="mis show_mis"><span class="n"><a href="#t372">372</a></span><span class="t">                        <span class="nam">sequence_code</span> <span class="op">=</span> <span class="str">'account.payment.supplier.invoice'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t373" class="mis show_mis"><span class="n"><a href="#t373">373</a></span><span class="t">            <span class="nam">rec</span><span class="op">.</span><span class="nam">name</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'ir.sequence'</span><span class="op">]</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">ir_sequence_date</span><span class="op">=</span><span class="nam">rec</span><span class="op">.</span><span class="nam">payment_date</span><span class="op">)</span><span class="op">.</span><span class="nam">next_by_code</span><span class="op">(</span><span class="nam">sequence_code</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t374" class="mis show_mis"><span class="n"><a href="#t374">374</a></span><span class="t">            <span class="key">if</span> <span class="key">not</span> <span class="nam">rec</span><span class="op">.</span><span class="nam">name</span> <span class="key">and</span> <span class="nam">rec</span><span class="op">.</span><span class="nam">payment_type</span> <span class="op">!=</span> <span class="str">'transfer'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t375" class="mis show_mis"><span class="n"><a href="#t375">375</a></span><span class="t">                <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">"You have to define a sequence for %s in your company."</span><span class="op">)</span> <span class="op">%</span> <span class="op">(</span><span class="nam">sequence_code</span><span class="op">,</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t376" class="pln"><span class="n"><a href="#t376">376</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t377" class="pln"><span class="n"><a href="#t377">377</a></span><span class="t">            <span class="com"># Create the journal entry</span>&nbsp;</span><span class="r"></span></p>
    <p id="t378" class="mis show_mis"><span class="n"><a href="#t378">378</a></span><span class="t">            <span class="nam">amount</span> <span class="op">=</span> <span class="nam">rec</span><span class="op">.</span><span class="nam">amount</span> <span class="op">*</span> <span class="op">(</span><span class="nam">rec</span><span class="op">.</span><span class="nam">payment_type</span> <span class="key">in</span> <span class="op">(</span><span class="str">'outbound'</span><span class="op">,</span> <span class="str">'transfer'</span><span class="op">)</span> <span class="key">and</span> <span class="num">1</span> <span class="key">or</span> <span class="op">-</span><span class="num">1</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t379" class="mis show_mis"><span class="n"><a href="#t379">379</a></span><span class="t">            <span class="nam">move</span> <span class="op">=</span> <span class="nam">rec</span><span class="op">.</span><span class="nam">_create_payment_entry</span><span class="op">(</span><span class="nam">amount</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t380" class="pln"><span class="n"><a href="#t380">380</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t381" class="pln"><span class="n"><a href="#t381">381</a></span><span class="t">            <span class="com"># In case of a transfer, the first journal entry created debited the source liquidity account and credited</span>&nbsp;</span><span class="r"></span></p>
    <p id="t382" class="pln"><span class="n"><a href="#t382">382</a></span><span class="t">            <span class="com"># the transfer account. Now we debit the transfer account and credit the destination liquidity account.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t383" class="mis show_mis"><span class="n"><a href="#t383">383</a></span><span class="t">            <span class="key">if</span> <span class="nam">rec</span><span class="op">.</span><span class="nam">payment_type</span> <span class="op">==</span> <span class="str">'transfer'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t384" class="mis show_mis"><span class="n"><a href="#t384">384</a></span><span class="t">                <span class="nam">transfer_credit_aml</span> <span class="op">=</span> <span class="nam">move</span><span class="op">.</span><span class="nam">line_ids</span><span class="op">.</span><span class="nam">filtered</span><span class="op">(</span><span class="key">lambda</span> <span class="nam">r</span><span class="op">:</span> <span class="nam">r</span><span class="op">.</span><span class="nam">account_id</span> <span class="op">==</span> <span class="nam">rec</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">transfer_account_id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t385" class="mis show_mis"><span class="n"><a href="#t385">385</a></span><span class="t">                <span class="nam">transfer_debit_aml</span> <span class="op">=</span> <span class="nam">rec</span><span class="op">.</span><span class="nam">_create_transfer_entry</span><span class="op">(</span><span class="nam">amount</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t386" class="mis show_mis"><span class="n"><a href="#t386">386</a></span><span class="t">                <span class="op">(</span><span class="nam">transfer_credit_aml</span> <span class="op">+</span> <span class="nam">transfer_debit_aml</span><span class="op">)</span><span class="op">.</span><span class="nam">reconcile</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t387" class="pln"><span class="n"><a href="#t387">387</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t388" class="mis show_mis"><span class="n"><a href="#t388">388</a></span><span class="t">            <span class="nam">rec</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="op">{</span><span class="str">'state'</span><span class="op">:</span> <span class="str">'posted'</span><span class="op">,</span> <span class="str">'move_name'</span><span class="op">:</span> <span class="nam">move</span><span class="op">.</span><span class="nam">name</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t389" class="pln"><span class="n"><a href="#t389">389</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t390" class="run"><span class="n"><a href="#t390">390</a></span><span class="t">    <span class="key">def</span> <span class="nam">_create_payment_entry</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">amount</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t391" class="pln"><span class="n"><a href="#t391">391</a></span><span class="t">        <span class="str">""" Create a journal entry corresponding to a payment, if the payment references invoice(s) they are reconciled.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t392" class="pln"><span class="n"><a href="#t392">392</a></span><span class="t"><span class="str">            Return the journal entry.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t393" class="pln"><span class="n"><a href="#t393">393</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t394" class="mis show_mis"><span class="n"><a href="#t394">394</a></span><span class="t">        <span class="nam">aml_obj</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move.line'</span><span class="op">]</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">check_move_validity</span><span class="op">=</span><span class="nam">False</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t395" class="mis show_mis"><span class="n"><a href="#t395">395</a></span><span class="t">        <span class="nam">invoice_currency</span> <span class="op">=</span> <span class="nam">False</span>&nbsp;</span><span class="r"></span></p>
    <p id="t396" class="mis show_mis"><span class="n"><a href="#t396">396</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">invoice_ids</span> <span class="key">and</span> <span class="nam">all</span><span class="op">(</span><span class="op">[</span><span class="nam">x</span><span class="op">.</span><span class="nam">currency_id</span> <span class="op">==</span> <span class="nam">self</span><span class="op">.</span><span class="nam">invoice_ids</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">for</span> <span class="nam">x</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">invoice_ids</span><span class="op">]</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t397" class="pln"><span class="n"><a href="#t397">397</a></span><span class="t">            <span class="com">#if all the invoices selected share the same currency, record the paiement in that currency too</span>&nbsp;</span><span class="r"></span></p>
    <p id="t398" class="mis show_mis"><span class="n"><a href="#t398">398</a></span><span class="t">            <span class="nam">invoice_currency</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">invoice_ids</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">currency_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t399" class="mis show_mis"><span class="n"><a href="#t399">399</a></span><span class="t">        <span class="nam">debit</span><span class="op">,</span> <span class="nam">credit</span><span class="op">,</span> <span class="nam">amount_currency</span><span class="op">,</span> <span class="nam">currency_id</span> <span class="op">=</span> <span class="nam">aml_obj</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">date</span><span class="op">=</span><span class="nam">self</span><span class="op">.</span><span class="nam">payment_date</span><span class="op">)</span><span class="op">.</span><span class="nam">compute_amount_fields</span><span class="op">(</span><span class="nam">amount</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">,</span> <span class="nam">invoice_currency</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t400" class="pln"><span class="n"><a href="#t400">400</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t401" class="mis show_mis"><span class="n"><a href="#t401">401</a></span><span class="t">        <span class="nam">move</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move'</span><span class="op">]</span><span class="op">.</span><span class="nam">create</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">_get_move_vals</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t402" class="pln"><span class="n"><a href="#t402">402</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t403" class="pln"><span class="n"><a href="#t403">403</a></span><span class="t">        <span class="com">#Write line corresponding to invoice payment</span>&nbsp;</span><span class="r"></span></p>
    <p id="t404" class="mis show_mis"><span class="n"><a href="#t404">404</a></span><span class="t">        <span class="nam">counterpart_aml_dict</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_get_shared_move_line_vals</span><span class="op">(</span><span class="nam">debit</span><span class="op">,</span> <span class="nam">credit</span><span class="op">,</span> <span class="nam">amount_currency</span><span class="op">,</span> <span class="nam">move</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">False</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t405" class="mis show_mis"><span class="n"><a href="#t405">405</a></span><span class="t">        <span class="nam">counterpart_aml_dict</span><span class="op">.</span><span class="nam">update</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">_get_counterpart_move_line_vals</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">invoice_ids</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t406" class="mis show_mis"><span class="n"><a href="#t406">406</a></span><span class="t">        <span class="nam">counterpart_aml_dict</span><span class="op">.</span><span class="nam">update</span><span class="op">(</span><span class="op">{</span><span class="str">'currency_id'</span><span class="op">:</span> <span class="nam">currency_id</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t407" class="mis show_mis"><span class="n"><a href="#t407">407</a></span><span class="t">        <span class="nam">counterpart_aml</span> <span class="op">=</span> <span class="nam">aml_obj</span><span class="op">.</span><span class="nam">create</span><span class="op">(</span><span class="nam">counterpart_aml_dict</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t408" class="pln"><span class="n"><a href="#t408">408</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t409" class="pln"><span class="n"><a href="#t409">409</a></span><span class="t">        <span class="com">#Reconcile with the invoices</span>&nbsp;</span><span class="r"></span></p>
    <p id="t410" class="mis show_mis"><span class="n"><a href="#t410">410</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_difference_handling</span> <span class="op">==</span> <span class="str">'reconcile'</span> <span class="key">and</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_difference</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t411" class="mis show_mis"><span class="n"><a href="#t411">411</a></span><span class="t">            <span class="nam">writeoff_line</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_get_shared_move_line_vals</span><span class="op">(</span><span class="num">0</span><span class="op">,</span> <span class="num">0</span><span class="op">,</span> <span class="num">0</span><span class="op">,</span> <span class="nam">move</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">False</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t412" class="mis show_mis"><span class="n"><a href="#t412">412</a></span><span class="t">            <span class="nam">amount_currency_wo</span><span class="op">,</span> <span class="nam">currency_id</span> <span class="op">=</span> <span class="nam">aml_obj</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">date</span><span class="op">=</span><span class="nam">self</span><span class="op">.</span><span class="nam">payment_date</span><span class="op">)</span><span class="op">.</span><span class="nam">compute_amount_fields</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">payment_difference</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">,</span> <span class="nam">invoice_currency</span><span class="op">)</span><span class="op">[</span><span class="num">2</span><span class="op">:</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t413" class="pln"><span class="n"><a href="#t413">413</a></span><span class="t">            <span class="com"># the writeoff debit and credit must be computed from the invoice residual in company currency</span>&nbsp;</span><span class="r"></span></p>
    <p id="t414" class="pln"><span class="n"><a href="#t414">414</a></span><span class="t">            <span class="com"># minus the payment amount in company currency, and not from the payment difference in the payment currency</span>&nbsp;</span><span class="r"></span></p>
    <p id="t415" class="pln"><span class="n"><a href="#t415">415</a></span><span class="t">            <span class="com"># to avoid loss of precision during the currency rate computations. See revision 20935462a0cabeb45480ce70114ff2f4e91eaf79 for a detailed example.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t416" class="mis show_mis"><span class="n"><a href="#t416">416</a></span><span class="t">            <span class="nam">total_residual_company_signed</span> <span class="op">=</span> <span class="nam">sum</span><span class="op">(</span><span class="nam">invoice</span><span class="op">.</span><span class="nam">residual_company_signed</span> <span class="key">for</span> <span class="nam">invoice</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">invoice_ids</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t417" class="mis show_mis"><span class="n"><a href="#t417">417</a></span><span class="t">            <span class="nam">total_payment_company_signed</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">date</span><span class="op">=</span><span class="nam">self</span><span class="op">.</span><span class="nam">payment_date</span><span class="op">)</span><span class="op">.</span><span class="nam">compute</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">amount</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t418" class="mis show_mis"><span class="n"><a href="#t418">418</a></span><span class="t">            <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">invoice_ids</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">type</span> <span class="key">in</span> <span class="op">[</span><span class="str">'in_invoice'</span><span class="op">,</span> <span class="str">'out_refund'</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t419" class="mis show_mis"><span class="n"><a href="#t419">419</a></span><span class="t">                <span class="nam">amount_wo</span> <span class="op">=</span> <span class="nam">total_payment_company_signed</span> <span class="op">-</span> <span class="nam">total_residual_company_signed</span>&nbsp;</span><span class="r"></span></p>
    <p id="t420" class="pln"><span class="n"><a href="#t420">420</a></span><span class="t">            <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t421" class="mis show_mis"><span class="n"><a href="#t421">421</a></span><span class="t">                <span class="nam">amount_wo</span> <span class="op">=</span> <span class="nam">total_residual_company_signed</span> <span class="op">-</span> <span class="nam">total_payment_company_signed</span>&nbsp;</span><span class="r"></span></p>
    <p id="t422" class="pln"><span class="n"><a href="#t422">422</a></span><span class="t">            <span class="com"># Align the sign of the secondary currency writeoff amount with the sign of the writeoff</span>&nbsp;</span><span class="r"></span></p>
    <p id="t423" class="pln"><span class="n"><a href="#t423">423</a></span><span class="t">            <span class="com"># amount in the company currency</span>&nbsp;</span><span class="r"></span></p>
    <p id="t424" class="mis show_mis"><span class="n"><a href="#t424">424</a></span><span class="t">            <span class="key">if</span> <span class="nam">amount_wo</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t425" class="mis show_mis"><span class="n"><a href="#t425">425</a></span><span class="t">                <span class="nam">debit_wo</span> <span class="op">=</span> <span class="nam">amount_wo</span>&nbsp;</span><span class="r"></span></p>
    <p id="t426" class="mis show_mis"><span class="n"><a href="#t426">426</a></span><span class="t">                <span class="nam">credit_wo</span> <span class="op">=</span> <span class="num">0.0</span>&nbsp;</span><span class="r"></span></p>
    <p id="t427" class="mis show_mis"><span class="n"><a href="#t427">427</a></span><span class="t">                <span class="nam">amount_currency_wo</span> <span class="op">=</span> <span class="nam">abs</span><span class="op">(</span><span class="nam">amount_currency_wo</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t428" class="pln"><span class="n"><a href="#t428">428</a></span><span class="t">            <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t429" class="mis show_mis"><span class="n"><a href="#t429">429</a></span><span class="t">                <span class="nam">debit_wo</span> <span class="op">=</span> <span class="num">0.0</span>&nbsp;</span><span class="r"></span></p>
    <p id="t430" class="mis show_mis"><span class="n"><a href="#t430">430</a></span><span class="t">                <span class="nam">credit_wo</span> <span class="op">=</span> <span class="op">-</span><span class="nam">amount_wo</span>&nbsp;</span><span class="r"></span></p>
    <p id="t431" class="mis show_mis"><span class="n"><a href="#t431">431</a></span><span class="t">                <span class="nam">amount_currency_wo</span> <span class="op">=</span> <span class="op">-</span><span class="nam">abs</span><span class="op">(</span><span class="nam">amount_currency_wo</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t432" class="mis show_mis"><span class="n"><a href="#t432">432</a></span><span class="t">            <span class="nam">writeoff_line</span><span class="op">[</span><span class="str">'name'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">_</span><span class="op">(</span><span class="str">'Counterpart'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t433" class="mis show_mis"><span class="n"><a href="#t433">433</a></span><span class="t">            <span class="nam">writeoff_line</span><span class="op">[</span><span class="str">'account_id'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">writeoff_account_id</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t434" class="mis show_mis"><span class="n"><a href="#t434">434</a></span><span class="t">            <span class="nam">writeoff_line</span><span class="op">[</span><span class="str">'debit'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">debit_wo</span>&nbsp;</span><span class="r"></span></p>
    <p id="t435" class="mis show_mis"><span class="n"><a href="#t435">435</a></span><span class="t">            <span class="nam">writeoff_line</span><span class="op">[</span><span class="str">'credit'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">credit_wo</span>&nbsp;</span><span class="r"></span></p>
    <p id="t436" class="mis show_mis"><span class="n"><a href="#t436">436</a></span><span class="t">            <span class="nam">writeoff_line</span><span class="op">[</span><span class="str">'amount_currency'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">amount_currency_wo</span>&nbsp;</span><span class="r"></span></p>
    <p id="t437" class="mis show_mis"><span class="n"><a href="#t437">437</a></span><span class="t">            <span class="nam">writeoff_line</span><span class="op">[</span><span class="str">'currency_id'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">currency_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t438" class="mis show_mis"><span class="n"><a href="#t438">438</a></span><span class="t">            <span class="nam">writeoff_line</span> <span class="op">=</span> <span class="nam">aml_obj</span><span class="op">.</span><span class="nam">create</span><span class="op">(</span><span class="nam">writeoff_line</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t439" class="mis show_mis"><span class="n"><a href="#t439">439</a></span><span class="t">            <span class="key">if</span> <span class="nam">counterpart_aml</span><span class="op">[</span><span class="str">'debit'</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t440" class="mis show_mis"><span class="n"><a href="#t440">440</a></span><span class="t">                <span class="nam">counterpart_aml</span><span class="op">[</span><span class="str">'debit'</span><span class="op">]</span> <span class="op">+=</span> <span class="nam">credit_wo</span> <span class="op">-</span> <span class="nam">debit_wo</span>&nbsp;</span><span class="r"></span></p>
    <p id="t441" class="mis show_mis"><span class="n"><a href="#t441">441</a></span><span class="t">            <span class="key">if</span> <span class="nam">counterpart_aml</span><span class="op">[</span><span class="str">'credit'</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t442" class="mis show_mis"><span class="n"><a href="#t442">442</a></span><span class="t">                <span class="nam">counterpart_aml</span><span class="op">[</span><span class="str">'credit'</span><span class="op">]</span> <span class="op">+=</span> <span class="nam">debit_wo</span> <span class="op">-</span> <span class="nam">credit_wo</span>&nbsp;</span><span class="r"></span></p>
    <p id="t443" class="mis show_mis"><span class="n"><a href="#t443">443</a></span><span class="t">            <span class="nam">counterpart_aml</span><span class="op">[</span><span class="str">'amount_currency'</span><span class="op">]</span> <span class="op">-=</span> <span class="nam">amount_currency_wo</span>&nbsp;</span><span class="r"></span></p>
    <p id="t444" class="mis show_mis"><span class="n"><a href="#t444">444</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">invoice_ids</span><span class="op">.</span><span class="nam">register_payment</span><span class="op">(</span><span class="nam">counterpart_aml</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t445" class="pln"><span class="n"><a href="#t445">445</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t446" class="pln"><span class="n"><a href="#t446">446</a></span><span class="t">        <span class="com">#Write counterpart lines</span>&nbsp;</span><span class="r"></span></p>
    <p id="t447" class="mis show_mis"><span class="n"><a href="#t447">447</a></span><span class="t">        <span class="key">if</span> <span class="key">not</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span> <span class="op">!=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t448" class="mis show_mis"><span class="n"><a href="#t448">448</a></span><span class="t">            <span class="nam">amount_currency</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p id="t449" class="mis show_mis"><span class="n"><a href="#t449">449</a></span><span class="t">        <span class="nam">liquidity_aml_dict</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_get_shared_move_line_vals</span><span class="op">(</span><span class="nam">credit</span><span class="op">,</span> <span class="nam">debit</span><span class="op">,</span> <span class="op">-</span><span class="nam">amount_currency</span><span class="op">,</span> <span class="nam">move</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">False</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t450" class="mis show_mis"><span class="n"><a href="#t450">450</a></span><span class="t">        <span class="nam">liquidity_aml_dict</span><span class="op">.</span><span class="nam">update</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">_get_liquidity_move_line_vals</span><span class="op">(</span><span class="op">-</span><span class="nam">amount</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t451" class="mis show_mis"><span class="n"><a href="#t451">451</a></span><span class="t">        <span class="nam">aml_obj</span><span class="op">.</span><span class="nam">create</span><span class="op">(</span><span class="nam">liquidity_aml_dict</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t452" class="pln"><span class="n"><a href="#t452">452</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t453" class="mis show_mis"><span class="n"><a href="#t453">453</a></span><span class="t">        <span class="nam">move</span><span class="op">.</span><span class="nam">post</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t454" class="mis show_mis"><span class="n"><a href="#t454">454</a></span><span class="t">        <span class="key">return</span> <span class="nam">move</span>&nbsp;</span><span class="r"></span></p>
    <p id="t455" class="pln"><span class="n"><a href="#t455">455</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t456" class="run"><span class="n"><a href="#t456">456</a></span><span class="t">    <span class="key">def</span> <span class="nam">_create_transfer_entry</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">amount</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t457" class="pln"><span class="n"><a href="#t457">457</a></span><span class="t">        <span class="str">""" Create the journal entry corresponding to the 'incoming money' part of an internal transfer, return the reconciliable move line</span>&nbsp;</span><span class="r"></span></p>
    <p id="t458" class="pln"><span class="n"><a href="#t458">458</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t459" class="mis show_mis"><span class="n"><a href="#t459">459</a></span><span class="t">        <span class="nam">aml_obj</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move.line'</span><span class="op">]</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">check_move_validity</span><span class="op">=</span><span class="nam">False</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t460" class="mis show_mis"><span class="n"><a href="#t460">460</a></span><span class="t">        <span class="nam">debit</span><span class="op">,</span> <span class="nam">credit</span><span class="op">,</span> <span class="nam">amount_currency</span><span class="op">,</span> <span class="nam">dummy</span> <span class="op">=</span> <span class="nam">aml_obj</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">date</span><span class="op">=</span><span class="nam">self</span><span class="op">.</span><span class="nam">payment_date</span><span class="op">)</span><span class="op">.</span><span class="nam">compute_amount_fields</span><span class="op">(</span><span class="nam">amount</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t461" class="mis show_mis"><span class="n"><a href="#t461">461</a></span><span class="t">        <span class="nam">amount_currency</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">destination_journal_id</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">and</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">date</span><span class="op">=</span><span class="nam">self</span><span class="op">.</span><span class="nam">payment_date</span><span class="op">)</span><span class="op">.</span><span class="nam">compute</span><span class="op">(</span><span class="nam">amount</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">destination_journal_id</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">)</span> <span class="key">or</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p id="t462" class="pln"><span class="n"><a href="#t462">462</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t463" class="mis show_mis"><span class="n"><a href="#t463">463</a></span><span class="t">        <span class="nam">dst_move</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move'</span><span class="op">]</span><span class="op">.</span><span class="nam">create</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">_get_move_vals</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">destination_journal_id</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t464" class="pln"><span class="n"><a href="#t464">464</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t465" class="mis show_mis"><span class="n"><a href="#t465">465</a></span><span class="t">        <span class="nam">dst_liquidity_aml_dict</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_get_shared_move_line_vals</span><span class="op">(</span><span class="nam">debit</span><span class="op">,</span> <span class="nam">credit</span><span class="op">,</span> <span class="nam">amount_currency</span><span class="op">,</span> <span class="nam">dst_move</span><span class="op">.</span><span class="nam">id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t466" class="mis show_mis"><span class="n"><a href="#t466">466</a></span><span class="t">        <span class="nam">dst_liquidity_aml_dict</span><span class="op">.</span><span class="nam">update</span><span class="op">(</span><span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t467" class="pln"><span class="n"><a href="#t467">467</a></span><span class="t">            <span class="str">'name'</span><span class="op">:</span> <span class="nam">_</span><span class="op">(</span><span class="str">'Transfer from %s'</span><span class="op">)</span> <span class="op">%</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">name</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t468" class="pln"><span class="n"><a href="#t468">468</a></span><span class="t">            <span class="str">'account_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">destination_journal_id</span><span class="op">.</span><span class="nam">default_credit_account_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t469" class="pln"><span class="n"><a href="#t469">469</a></span><span class="t">            <span class="str">'currency_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">destination_journal_id</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t470" class="pln"><span class="n"><a href="#t470">470</a></span><span class="t">            <span class="str">'payment_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t471" class="pln"><span class="n"><a href="#t471">471</a></span><span class="t">            <span class="str">'journal_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">destination_journal_id</span><span class="op">.</span><span class="nam">id</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t472" class="mis show_mis"><span class="n"><a href="#t472">472</a></span><span class="t">        <span class="nam">aml_obj</span><span class="op">.</span><span class="nam">create</span><span class="op">(</span><span class="nam">dst_liquidity_aml_dict</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t473" class="pln"><span class="n"><a href="#t473">473</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t474" class="mis show_mis"><span class="n"><a href="#t474">474</a></span><span class="t">        <span class="nam">transfer_debit_aml_dict</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_get_shared_move_line_vals</span><span class="op">(</span><span class="nam">credit</span><span class="op">,</span> <span class="nam">debit</span><span class="op">,</span> <span class="num">0</span><span class="op">,</span> <span class="nam">dst_move</span><span class="op">.</span><span class="nam">id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t475" class="mis show_mis"><span class="n"><a href="#t475">475</a></span><span class="t">        <span class="nam">transfer_debit_aml_dict</span><span class="op">.</span><span class="nam">update</span><span class="op">(</span><span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t476" class="pln"><span class="n"><a href="#t476">476</a></span><span class="t">            <span class="str">'name'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">name</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t477" class="pln"><span class="n"><a href="#t477">477</a></span><span class="t">            <span class="str">'payment_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t478" class="pln"><span class="n"><a href="#t478">478</a></span><span class="t">            <span class="str">'account_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">transfer_account_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t479" class="pln"><span class="n"><a href="#t479">479</a></span><span class="t">            <span class="str">'journal_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">destination_journal_id</span><span class="op">.</span><span class="nam">id</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t480" class="mis show_mis"><span class="n"><a href="#t480">480</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span> <span class="op">!=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t481" class="mis show_mis"><span class="n"><a href="#t481">481</a></span><span class="t">            <span class="nam">transfer_debit_aml_dict</span><span class="op">.</span><span class="nam">update</span><span class="op">(</span><span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t482" class="pln"><span class="n"><a href="#t482">482</a></span><span class="t">                <span class="str">'currency_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t483" class="pln"><span class="n"><a href="#t483">483</a></span><span class="t">                <span class="str">'amount_currency'</span><span class="op">:</span> <span class="op">-</span><span class="nam">self</span><span class="op">.</span><span class="nam">amount</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t484" class="pln"><span class="n"><a href="#t484">484</a></span><span class="t">            <span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t485" class="mis show_mis"><span class="n"><a href="#t485">485</a></span><span class="t">        <span class="nam">transfer_debit_aml</span> <span class="op">=</span> <span class="nam">aml_obj</span><span class="op">.</span><span class="nam">create</span><span class="op">(</span><span class="nam">transfer_debit_aml_dict</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t486" class="mis show_mis"><span class="n"><a href="#t486">486</a></span><span class="t">        <span class="nam">dst_move</span><span class="op">.</span><span class="nam">post</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t487" class="mis show_mis"><span class="n"><a href="#t487">487</a></span><span class="t">        <span class="key">return</span> <span class="nam">transfer_debit_aml</span>&nbsp;</span><span class="r"></span></p>
    <p id="t488" class="pln"><span class="n"><a href="#t488">488</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t489" class="run"><span class="n"><a href="#t489">489</a></span><span class="t">    <span class="key">def</span> <span class="nam">_get_move_vals</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">journal</span><span class="op">=</span><span class="nam">None</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t490" class="pln"><span class="n"><a href="#t490">490</a></span><span class="t">        <span class="str">""" Return dict to create the payment move</span>&nbsp;</span><span class="r"></span></p>
    <p id="t491" class="pln"><span class="n"><a href="#t491">491</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t492" class="mis show_mis"><span class="n"><a href="#t492">492</a></span><span class="t">        <span class="nam">journal</span> <span class="op">=</span> <span class="nam">journal</span> <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t493" class="mis show_mis"><span class="n"><a href="#t493">493</a></span><span class="t">        <span class="key">if</span> <span class="key">not</span> <span class="nam">journal</span><span class="op">.</span><span class="nam">sequence_id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t494" class="mis show_mis"><span class="n"><a href="#t494">494</a></span><span class="t">            <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'Configuration Error !'</span><span class="op">)</span><span class="op">,</span> <span class="nam">_</span><span class="op">(</span><span class="str">'The journal %s does not have a sequence, please specify one.'</span><span class="op">)</span> <span class="op">%</span> <span class="nam">journal</span><span class="op">.</span><span class="nam">name</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t495" class="mis show_mis"><span class="n"><a href="#t495">495</a></span><span class="t">        <span class="key">if</span> <span class="key">not</span> <span class="nam">journal</span><span class="op">.</span><span class="nam">sequence_id</span><span class="op">.</span><span class="nam">active</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t496" class="mis show_mis"><span class="n"><a href="#t496">496</a></span><span class="t">            <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'Configuration Error !'</span><span class="op">)</span><span class="op">,</span> <span class="nam">_</span><span class="op">(</span><span class="str">'The sequence of journal %s is deactivated.'</span><span class="op">)</span> <span class="op">%</span> <span class="nam">journal</span><span class="op">.</span><span class="nam">name</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t497" class="mis show_mis"><span class="n"><a href="#t497">497</a></span><span class="t">        <span class="nam">name</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">move_name</span> <span class="key">or</span> <span class="nam">journal</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">ir_sequence_date</span><span class="op">=</span><span class="nam">self</span><span class="op">.</span><span class="nam">payment_date</span><span class="op">)</span><span class="op">.</span><span class="nam">sequence_id</span><span class="op">.</span><span class="nam">next_by_id</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t498" class="mis show_mis"><span class="n"><a href="#t498">498</a></span><span class="t">        <span class="key">return</span> <span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t499" class="pln"><span class="n"><a href="#t499">499</a></span><span class="t">            <span class="str">'name'</span><span class="op">:</span> <span class="nam">name</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t500" class="pln"><span class="n"><a href="#t500">500</a></span><span class="t">            <span class="str">'date'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_date</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t501" class="pln"><span class="n"><a href="#t501">501</a></span><span class="t">            <span class="str">'ref'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">communication</span> <span class="key">or</span> <span class="str">''</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t502" class="pln"><span class="n"><a href="#t502">502</a></span><span class="t">            <span class="str">'company_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t503" class="pln"><span class="n"><a href="#t503">503</a></span><span class="t">            <span class="str">'journal_id'</span><span class="op">:</span> <span class="nam">journal</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t504" class="pln"><span class="n"><a href="#t504">504</a></span><span class="t">        <span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t505" class="pln"><span class="n"><a href="#t505">505</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t506" class="run"><span class="n"><a href="#t506">506</a></span><span class="t">    <span class="key">def</span> <span class="nam">_get_shared_move_line_vals</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">debit</span><span class="op">,</span> <span class="nam">credit</span><span class="op">,</span> <span class="nam">amount_currency</span><span class="op">,</span> <span class="nam">move_id</span><span class="op">,</span> <span class="nam">invoice_id</span><span class="op">=</span><span class="nam">False</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t507" class="pln"><span class="n"><a href="#t507">507</a></span><span class="t">        <span class="str">""" Returns values common to both move lines (except for debit, credit and amount_currency which are reversed)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t508" class="pln"><span class="n"><a href="#t508">508</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t509" class="mis show_mis"><span class="n"><a href="#t509">509</a></span><span class="t">        <span class="key">return</span> <span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t510" class="pln"><span class="n"><a href="#t510">510</a></span><span class="t">            <span class="str">'partner_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_type</span> <span class="key">in</span> <span class="op">(</span><span class="str">'inbound'</span><span class="op">,</span> <span class="str">'outbound'</span><span class="op">)</span> <span class="key">and</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'res.partner'</span><span class="op">]</span><span class="op">.</span><span class="nam">_find_accounting_partner</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">)</span><span class="op">.</span><span class="nam">id</span> <span class="key">or</span> <span class="nam">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t511" class="pln"><span class="n"><a href="#t511">511</a></span><span class="t">            <span class="str">'invoice_id'</span><span class="op">:</span> <span class="nam">invoice_id</span> <span class="key">and</span> <span class="nam">invoice_id</span><span class="op">.</span><span class="nam">id</span> <span class="key">or</span> <span class="nam">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t512" class="pln"><span class="n"><a href="#t512">512</a></span><span class="t">            <span class="str">'move_id'</span><span class="op">:</span> <span class="nam">move_id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t513" class="pln"><span class="n"><a href="#t513">513</a></span><span class="t">            <span class="str">'debit'</span><span class="op">:</span> <span class="nam">debit</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t514" class="pln"><span class="n"><a href="#t514">514</a></span><span class="t">            <span class="str">'credit'</span><span class="op">:</span> <span class="nam">credit</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t515" class="pln"><span class="n"><a href="#t515">515</a></span><span class="t">            <span class="str">'amount_currency'</span><span class="op">:</span> <span class="nam">amount_currency</span> <span class="key">or</span> <span class="nam">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t516" class="pln"><span class="n"><a href="#t516">516</a></span><span class="t">        <span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t517" class="pln"><span class="n"><a href="#t517">517</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t518" class="run"><span class="n"><a href="#t518">518</a></span><span class="t">    <span class="key">def</span> <span class="nam">_get_counterpart_move_line_vals</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">invoice</span><span class="op">=</span><span class="nam">False</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t519" class="mis show_mis"><span class="n"><a href="#t519">519</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_type</span> <span class="op">==</span> <span class="str">'transfer'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t520" class="mis show_mis"><span class="n"><a href="#t520">520</a></span><span class="t">            <span class="nam">name</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">name</span>&nbsp;</span><span class="r"></span></p>
    <p id="t521" class="pln"><span class="n"><a href="#t521">521</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t522" class="mis show_mis"><span class="n"><a href="#t522">522</a></span><span class="t">            <span class="nam">name</span> <span class="op">=</span> <span class="str">''</span>&nbsp;</span><span class="r"></span></p>
    <p id="t523" class="mis show_mis"><span class="n"><a href="#t523">523</a></span><span class="t">            <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_type</span> <span class="op">==</span> <span class="str">'customer'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t524" class="mis show_mis"><span class="n"><a href="#t524">524</a></span><span class="t">                <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_type</span> <span class="op">==</span> <span class="str">'inbound'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t525" class="mis show_mis"><span class="n"><a href="#t525">525</a></span><span class="t">                    <span class="nam">name</span> <span class="op">+=</span> <span class="nam">_</span><span class="op">(</span><span class="str">"Customer Payment"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t526" class="mis show_mis"><span class="n"><a href="#t526">526</a></span><span class="t">                <span class="key">elif</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_type</span> <span class="op">==</span> <span class="str">'outbound'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t527" class="mis show_mis"><span class="n"><a href="#t527">527</a></span><span class="t">                    <span class="nam">name</span> <span class="op">+=</span> <span class="nam">_</span><span class="op">(</span><span class="str">"Customer Refund"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t528" class="mis show_mis"><span class="n"><a href="#t528">528</a></span><span class="t">            <span class="key">elif</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_type</span> <span class="op">==</span> <span class="str">'supplier'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t529" class="mis show_mis"><span class="n"><a href="#t529">529</a></span><span class="t">                <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_type</span> <span class="op">==</span> <span class="str">'inbound'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t530" class="mis show_mis"><span class="n"><a href="#t530">530</a></span><span class="t">                    <span class="nam">name</span> <span class="op">+=</span> <span class="nam">_</span><span class="op">(</span><span class="str">"Vendor Refund"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t531" class="mis show_mis"><span class="n"><a href="#t531">531</a></span><span class="t">                <span class="key">elif</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_type</span> <span class="op">==</span> <span class="str">'outbound'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t532" class="mis show_mis"><span class="n"><a href="#t532">532</a></span><span class="t">                    <span class="nam">name</span> <span class="op">+=</span> <span class="nam">_</span><span class="op">(</span><span class="str">"Vendor Payment"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t533" class="mis show_mis"><span class="n"><a href="#t533">533</a></span><span class="t">            <span class="key">if</span> <span class="nam">invoice</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t534" class="mis show_mis"><span class="n"><a href="#t534">534</a></span><span class="t">                <span class="nam">name</span> <span class="op">+=</span> <span class="str">': '</span>&nbsp;</span><span class="r"></span></p>
    <p id="t535" class="mis show_mis"><span class="n"><a href="#t535">535</a></span><span class="t">                <span class="key">for</span> <span class="nam">inv</span> <span class="key">in</span> <span class="nam">invoice</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t536" class="mis show_mis"><span class="n"><a href="#t536">536</a></span><span class="t">                    <span class="key">if</span> <span class="nam">inv</span><span class="op">.</span><span class="nam">move_id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t537" class="mis show_mis"><span class="n"><a href="#t537">537</a></span><span class="t">                        <span class="nam">name</span> <span class="op">+=</span> <span class="nam">inv</span><span class="op">.</span><span class="nam">number</span> <span class="op">+</span> <span class="str">', '</span>&nbsp;</span><span class="r"></span></p>
    <p id="t538" class="mis show_mis"><span class="n"><a href="#t538">538</a></span><span class="t">                <span class="nam">name</span> <span class="op">=</span> <span class="nam">name</span><span class="op">[</span><span class="op">:</span><span class="nam">len</span><span class="op">(</span><span class="nam">name</span><span class="op">)</span><span class="op">-</span><span class="num">2</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t539" class="mis show_mis"><span class="n"><a href="#t539">539</a></span><span class="t">        <span class="key">return</span> <span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t540" class="pln"><span class="n"><a href="#t540">540</a></span><span class="t">            <span class="str">'name'</span><span class="op">:</span> <span class="nam">name</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t541" class="pln"><span class="n"><a href="#t541">541</a></span><span class="t">            <span class="str">'account_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">destination_account_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t542" class="pln"><span class="n"><a href="#t542">542</a></span><span class="t">            <span class="str">'journal_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t543" class="pln"><span class="n"><a href="#t543">543</a></span><span class="t">            <span class="str">'currency_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span> <span class="op">!=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">and</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">.</span><span class="nam">id</span> <span class="key">or</span> <span class="nam">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t544" class="pln"><span class="n"><a href="#t544">544</a></span><span class="t">            <span class="str">'payment_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t545" class="pln"><span class="n"><a href="#t545">545</a></span><span class="t">        <span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t546" class="pln"><span class="n"><a href="#t546">546</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t547" class="run"><span class="n"><a href="#t547">547</a></span><span class="t">    <span class="key">def</span> <span class="nam">_get_liquidity_move_line_vals</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">amount</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t548" class="mis show_mis"><span class="n"><a href="#t548">548</a></span><span class="t">        <span class="nam">name</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">name</span>&nbsp;</span><span class="r"></span></p>
    <p id="t549" class="mis show_mis"><span class="n"><a href="#t549">549</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_type</span> <span class="op">==</span> <span class="str">'transfer'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t550" class="mis show_mis"><span class="n"><a href="#t550">550</a></span><span class="t">            <span class="nam">name</span> <span class="op">=</span> <span class="nam">_</span><span class="op">(</span><span class="str">'Transfer to %s'</span><span class="op">)</span> <span class="op">%</span> <span class="nam">self</span><span class="op">.</span><span class="nam">destination_journal_id</span><span class="op">.</span><span class="nam">name</span>&nbsp;</span><span class="r"></span></p>
    <p id="t551" class="mis show_mis"><span class="n"><a href="#t551">551</a></span><span class="t">        <span class="nam">vals</span> <span class="op">=</span> <span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t552" class="pln"><span class="n"><a href="#t552">552</a></span><span class="t">            <span class="str">'name'</span><span class="op">:</span> <span class="nam">name</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t553" class="pln"><span class="n"><a href="#t553">553</a></span><span class="t">            <span class="str">'account_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">payment_type</span> <span class="key">in</span> <span class="op">(</span><span class="str">'outbound'</span><span class="op">,</span><span class="str">'transfer'</span><span class="op">)</span> <span class="key">and</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">default_debit_account_id</span><span class="op">.</span><span class="nam">id</span> <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">default_credit_account_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t554" class="pln"><span class="n"><a href="#t554">554</a></span><span class="t">            <span class="str">'payment_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t555" class="pln"><span class="n"><a href="#t555">555</a></span><span class="t">            <span class="str">'journal_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t556" class="pln"><span class="n"><a href="#t556">556</a></span><span class="t">            <span class="str">'currency_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span> <span class="op">!=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">and</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">.</span><span class="nam">id</span> <span class="key">or</span> <span class="nam">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t557" class="pln"><span class="n"><a href="#t557">557</a></span><span class="t">        <span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t558" class="pln"><span class="n"><a href="#t558">558</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t559" class="pln"><span class="n"><a href="#t559">559</a></span><span class="t">        <span class="com"># If the journal has a currency specified, the journal item need to be expressed in this currency</span>&nbsp;</span><span class="r"></span></p>
    <p id="t560" class="mis show_mis"><span class="n"><a href="#t560">560</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">and</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span> <span class="op">!=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t561" class="mis show_mis"><span class="n"><a href="#t561">561</a></span><span class="t">            <span class="nam">amount</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">date</span><span class="op">=</span><span class="nam">self</span><span class="op">.</span><span class="nam">payment_date</span><span class="op">)</span><span class="op">.</span><span class="nam">compute</span><span class="op">(</span><span class="nam">amount</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t562" class="mis show_mis"><span class="n"><a href="#t562">562</a></span><span class="t">            <span class="nam">debit</span><span class="op">,</span> <span class="nam">credit</span><span class="op">,</span> <span class="nam">amount_currency</span><span class="op">,</span> <span class="nam">dummy</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move.line'</span><span class="op">]</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">date</span><span class="op">=</span><span class="nam">self</span><span class="op">.</span><span class="nam">payment_date</span><span class="op">)</span><span class="op">.</span><span class="nam">compute_amount_fields</span><span class="op">(</span><span class="nam">amount</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t563" class="mis show_mis"><span class="n"><a href="#t563">563</a></span><span class="t">            <span class="nam">vals</span><span class="op">.</span><span class="nam">update</span><span class="op">(</span><span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t564" class="pln"><span class="n"><a href="#t564">564</a></span><span class="t">                <span class="str">'amount_currency'</span><span class="op">:</span> <span class="nam">amount_currency</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t565" class="pln"><span class="n"><a href="#t565">565</a></span><span class="t">                <span class="str">'currency_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t566" class="pln"><span class="n"><a href="#t566">566</a></span><span class="t">            <span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t567" class="pln"><span class="n"><a href="#t567">567</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t568" class="mis show_mis"><span class="n"><a href="#t568">568</a></span><span class="t">        <span class="key">return</span> <span class="nam">vals</span>&nbsp;</span><span class="r"></span></p>
</div>
<div id="footer">
    <div class="content">
        <p>
            <a class="nav" href="index.html">&#xab; index</a> &nbsp; &nbsp; <a class="nav" href="https://coverage.readthedocs.io">coverage.py v5.4</a>,
            created at 2021-02-24 19:43
        </p>
    </div>
</div>
</body>
</html>
