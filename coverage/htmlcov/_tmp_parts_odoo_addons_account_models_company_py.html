<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=emulateIE7" />
    <title>Coverage for /tmp/parts/odoo/addons/account/models/company.py: 46%</title>
    <link rel="icon" sizes="32x32" href="favicon_32.png">
    <link rel="stylesheet" href="style.css" type="text/css">
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="jquery.hotkeys.js"></script>
    <script type="text/javascript" src="jquery.isonscreen.js"></script>
    <script type="text/javascript" src="coverage_html.js"></script>
    <script type="text/javascript">
        jQuery(document).ready(coverage.pyfile_ready);
    </script>
</head>
<body class="pyfile">
<div id="header">
    <div class="content">
        <h1>Coverage for <b>/tmp/parts/odoo/addons/account/models/company.py</b> :
            <span class="pc_cov">46%</span>
        </h1>
        <img id="keyboard_icon" src="keybd_closed.png" alt="Show keyboard shortcuts" />
        <h2 class="stats">
            102 statements &nbsp;
            <button type="button" class="run shortkey_r button_toggle_run" title="Toggle lines run">47 run</button>
            <button type="button" class="mis show_mis shortkey_m button_toggle_mis" title="Toggle lines missing">55 missing</button>
            <button type="button" class="exc show_exc shortkey_x button_toggle_exc" title="Toggle lines excluded">0 excluded</button>
        </h2>
    </div>
</div>
<div class="help_panel">
    <img id="panel_icon" src="keybd_open.png" alt="Hide keyboard shortcuts" />
    <p class="legend">Hot-keys on this page</p>
    <div>
    <p class="keyhelp">
        <span class="key">r</span>
        <span class="key">m</span>
        <span class="key">x</span>
        <span class="key">p</span> &nbsp; toggle line displays
    </p>
    <p class="keyhelp">
        <span class="key">j</span>
        <span class="key">k</span> &nbsp; next/prev highlighted chunk
    </p>
    <p class="keyhelp">
        <span class="key">0</span> &nbsp; (zero) top of page
    </p>
    <p class="keyhelp">
        <span class="key">1</span> &nbsp; (one) first highlighted chunk
    </p>
    </div>
</div>
<div id="source">
    <p id="t1" class="pln"><span class="n"><a href="#t1">1</a></span><span class="t"><span class="com"># -*- coding: utf-8 -*-</span>&nbsp;</span><span class="r"></span></p>
    <p id="t2" class="pln"><span class="n"><a href="#t2">2</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t3" class="run"><span class="n"><a href="#t3">3</a></span><span class="t"><span class="key">from</span> <span class="nam">datetime</span> <span class="key">import</span> <span class="nam">timedelta</span><span class="op">,</span> <span class="nam">datetime</span>&nbsp;</span><span class="r"></span></p>
    <p id="t4" class="run"><span class="n"><a href="#t4">4</a></span><span class="t"><span class="key">import</span> <span class="nam">calendar</span>&nbsp;</span><span class="r"></span></p>
    <p id="t5" class="run"><span class="n"><a href="#t5">5</a></span><span class="t"><span class="key">import</span> <span class="nam">time</span>&nbsp;</span><span class="r"></span></p>
    <p id="t6" class="run"><span class="n"><a href="#t6">6</a></span><span class="t"><span class="key">from</span> <span class="nam">dateutil</span><span class="op">.</span><span class="nam">relativedelta</span> <span class="key">import</span> <span class="nam">relativedelta</span>&nbsp;</span><span class="r"></span></p>
    <p id="t7" class="pln"><span class="n"><a href="#t7">7</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t8" class="run"><span class="n"><a href="#t8">8</a></span><span class="t"><span class="key">from</span> <span class="nam">odoo</span> <span class="key">import</span> <span class="nam">fields</span><span class="op">,</span> <span class="nam">models</span><span class="op">,</span> <span class="nam">api</span><span class="op">,</span> <span class="nam">_</span>&nbsp;</span><span class="r"></span></p>
    <p id="t9" class="run"><span class="n"><a href="#t9">9</a></span><span class="t"><span class="key">from</span> <span class="nam">odoo</span><span class="op">.</span><span class="nam">exceptions</span> <span class="key">import</span> <span class="nam">ValidationError</span><span class="op">,</span> <span class="nam">UserError</span>&nbsp;</span><span class="r"></span></p>
    <p id="t10" class="run"><span class="n"><a href="#t10">10</a></span><span class="t"><span class="key">from</span> <span class="nam">odoo</span><span class="op">.</span><span class="nam">tools</span><span class="op">.</span><span class="nam">misc</span> <span class="key">import</span> <span class="nam">DEFAULT_SERVER_DATE_FORMAT</span>&nbsp;</span><span class="r"></span></p>
    <p id="t11" class="pln"><span class="n"><a href="#t11">11</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t12" class="pln"><span class="n"><a href="#t12">12</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t13" class="run"><span class="n"><a href="#t13">13</a></span><span class="t"><span class="key">class</span> <span class="nam">ResCompany</span><span class="op">(</span><span class="nam">models</span><span class="op">.</span><span class="nam">Model</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t14" class="run"><span class="n"><a href="#t14">14</a></span><span class="t">    <span class="nam">_inherit</span> <span class="op">=</span> <span class="str">"res.company"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t15" class="pln"><span class="n"><a href="#t15">15</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t16" class="pln"><span class="n"><a href="#t16">16</a></span><span class="t">    <span class="com">#TODO check all the options/fields are in the views (settings + company form view)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t17" class="run"><span class="n"><a href="#t17">17</a></span><span class="t">    <span class="nam">fiscalyear_last_day</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Integer</span><span class="op">(</span><span class="nam">default</span><span class="op">=</span><span class="num">31</span><span class="op">,</span> <span class="nam">required</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t18" class="run"><span class="n"><a href="#t18">18</a></span><span class="t">    <span class="nam">fiscalyear_last_month</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Selection</span><span class="op">(</span><span class="op">[</span><span class="op">(</span><span class="num">1</span><span class="op">,</span> <span class="str">'January'</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="num">2</span><span class="op">,</span> <span class="str">'February'</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="num">3</span><span class="op">,</span> <span class="str">'March'</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="num">4</span><span class="op">,</span> <span class="str">'April'</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="num">5</span><span class="op">,</span> <span class="str">'May'</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="num">6</span><span class="op">,</span> <span class="str">'June'</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="num">7</span><span class="op">,</span> <span class="str">'July'</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="num">8</span><span class="op">,</span> <span class="str">'August'</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="num">9</span><span class="op">,</span> <span class="str">'September'</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="num">10</span><span class="op">,</span> <span class="str">'October'</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="num">11</span><span class="op">,</span> <span class="str">'November'</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="num">12</span><span class="op">,</span> <span class="str">'December'</span><span class="op">)</span><span class="op">]</span><span class="op">,</span> <span class="nam">default</span><span class="op">=</span><span class="num">12</span><span class="op">,</span> <span class="nam">required</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t19" class="run"><span class="n"><a href="#t19">19</a></span><span class="t">    <span class="nam">period_lock_date</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Date</span><span class="op">(</span><span class="nam">string</span><span class="op">=</span><span class="str">"Lock Date for Non-Advisers"</span><span class="op">,</span> <span class="nam">help</span><span class="op">=</span><span class="str">"Only users with the 'Adviser' role can edit accounts prior to and inclusive of this date. Use it for period locking inside an open fiscal year, for example."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t20" class="run"><span class="n"><a href="#t20">20</a></span><span class="t">    <span class="nam">fiscalyear_lock_date</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Date</span><span class="op">(</span><span class="nam">string</span><span class="op">=</span><span class="str">"Lock Date"</span><span class="op">,</span> <span class="nam">help</span><span class="op">=</span><span class="str">"No users, including Advisers, can edit accounts prior to and inclusive of this date. Use it for fiscal year locking for example."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t21" class="run"><span class="n"><a href="#t21">21</a></span><span class="t">    <span class="nam">transfer_account_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'account.account'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t22" class="pln"><span class="n"><a href="#t22">22</a></span><span class="t">        <span class="nam">domain</span><span class="op">=</span><span class="key">lambda</span> <span class="nam">self</span><span class="op">:</span> <span class="op">[</span><span class="op">(</span><span class="str">'reconcile'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="nam">True</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="str">'user_type_id.id'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">ref</span><span class="op">(</span><span class="str">'account.data_account_type_current_assets'</span><span class="op">)</span><span class="op">.</span><span class="nam">id</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="str">'deprecated'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="nam">False</span><span class="op">)</span><span class="op">]</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">"Inter-Banks Transfer Account"</span><span class="op">,</span> <span class="nam">help</span><span class="op">=</span><span class="str">"Intermediary account used when moving money from a liquidity account to another"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t23" class="run"><span class="n"><a href="#t23">23</a></span><span class="t">    <span class="nam">expects_chart_of_accounts</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Boolean</span><span class="op">(</span><span class="nam">string</span><span class="op">=</span><span class="str">'Expects a Chart of Accounts'</span><span class="op">,</span> <span class="nam">default</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t24" class="run"><span class="n"><a href="#t24">24</a></span><span class="t">    <span class="nam">chart_template_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'account.chart.template'</span><span class="op">,</span> <span class="nam">help</span><span class="op">=</span><span class="str">'The chart template for the company (if any)'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t25" class="run"><span class="n"><a href="#t25">25</a></span><span class="t">    <span class="nam">bank_account_code_prefix</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Char</span><span class="op">(</span><span class="nam">string</span><span class="op">=</span><span class="str">'Prefix of the bank accounts'</span><span class="op">,</span> <span class="nam">oldname</span><span class="op">=</span><span class="str">"bank_account_code_char"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t26" class="run"><span class="n"><a href="#t26">26</a></span><span class="t">    <span class="nam">cash_account_code_prefix</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Char</span><span class="op">(</span><span class="nam">string</span><span class="op">=</span><span class="str">'Prefix of the cash accounts'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t27" class="run"><span class="n"><a href="#t27">27</a></span><span class="t">    <span class="nam">accounts_code_digits</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Integer</span><span class="op">(</span><span class="nam">string</span><span class="op">=</span><span class="str">'Number of digits in an account code'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t28" class="run"><span class="n"><a href="#t28">28</a></span><span class="t">    <span class="nam">tax_calculation_rounding_method</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Selection</span><span class="op">(</span><span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p id="t29" class="pln"><span class="n"><a href="#t29">29</a></span><span class="t">        <span class="op">(</span><span class="str">'round_per_line'</span><span class="op">,</span> <span class="str">'Round per Line'</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t30" class="pln"><span class="n"><a href="#t30">30</a></span><span class="t">        <span class="op">(</span><span class="str">'round_globally'</span><span class="op">,</span> <span class="str">'Round Globally'</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t31" class="pln"><span class="n"><a href="#t31">31</a></span><span class="t">        <span class="op">]</span><span class="op">,</span> <span class="nam">default</span><span class="op">=</span><span class="str">'round_per_line'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Tax Calculation Rounding Method'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t32" class="pln"><span class="n"><a href="#t32">32</a></span><span class="t">        <span class="nam">help</span><span class="op">=</span><span class="str">"If you select 'Round per Line' : for each tax, the tax amount will first be computed and rounded for each PO/SO/invoice line and then these rounded amounts will be summed, leading to the total amount for that tax. If you select 'Round Globally': for each tax, the tax amount will be computed for each PO/SO/invoice line, then these amounts will be summed and eventually this total tax amount will be rounded. If you sell with tax included, you should choose 'Round per line' because you certainly want the sum of your tax-included line subtotals to be equal to the total amount with taxes."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t33" class="run"><span class="n"><a href="#t33">33</a></span><span class="t">    <span class="nam">currency_exchange_journal_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'account.journal'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">"Exchange Gain or Loss Journal"</span><span class="op">,</span> <span class="nam">domain</span><span class="op">=</span><span class="op">[</span><span class="op">(</span><span class="str">'type'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="str">'general'</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t34" class="run"><span class="n"><a href="#t34">34</a></span><span class="t">    <span class="nam">income_currency_exchange_account_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'account.account'</span><span class="op">,</span> <span class="nam">related</span><span class="op">=</span><span class="str">'currency_exchange_journal_id.default_credit_account_id'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t35" class="pln"><span class="n"><a href="#t35">35</a></span><span class="t">        <span class="nam">string</span><span class="op">=</span><span class="str">"Gain Exchange Rate Account"</span><span class="op">,</span> <span class="nam">domain</span><span class="op">=</span><span class="str">"[('internal_type', '=', 'other'), ('deprecated', '=', False), ('company_id', '=', id)]"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t36" class="run"><span class="n"><a href="#t36">36</a></span><span class="t">    <span class="nam">expense_currency_exchange_account_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'account.account'</span><span class="op">,</span> <span class="nam">related</span><span class="op">=</span><span class="str">'currency_exchange_journal_id.default_debit_account_id'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t37" class="pln"><span class="n"><a href="#t37">37</a></span><span class="t">        <span class="nam">string</span><span class="op">=</span><span class="str">"Loss Exchange Rate Account"</span><span class="op">,</span> <span class="nam">domain</span><span class="op">=</span><span class="str">"[('internal_type', '=', 'other'), ('deprecated', '=', False), ('company_id', '=', id)]"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t38" class="run"><span class="n"><a href="#t38">38</a></span><span class="t">    <span class="nam">anglo_saxon_accounting</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Boolean</span><span class="op">(</span><span class="nam">string</span><span class="op">=</span><span class="str">"Use anglo-saxon accounting"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t39" class="run"><span class="n"><a href="#t39">39</a></span><span class="t">    <span class="nam">property_stock_account_input_categ_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'account.account'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">"Input Account for Stock Valuation"</span><span class="op">,</span> <span class="nam">oldname</span><span class="op">=</span><span class="str">"property_stock_account_input_categ"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t40" class="run"><span class="n"><a href="#t40">40</a></span><span class="t">    <span class="nam">property_stock_account_output_categ_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'account.account'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">"Output Account for Stock Valuation"</span><span class="op">,</span> <span class="nam">oldname</span><span class="op">=</span><span class="str">"property_stock_account_output_categ"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t41" class="run"><span class="n"><a href="#t41">41</a></span><span class="t">    <span class="nam">property_stock_valuation_account_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'account.account'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">"Account Template for Stock Valuation"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t42" class="run"><span class="n"><a href="#t42">42</a></span><span class="t">    <span class="nam">bank_journal_ids</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">One2many</span><span class="op">(</span><span class="str">'account.journal'</span><span class="op">,</span> <span class="str">'company_id'</span><span class="op">,</span> <span class="nam">domain</span><span class="op">=</span><span class="op">[</span><span class="op">(</span><span class="str">'type'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="str">'bank'</span><span class="op">)</span><span class="op">]</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Bank Journals'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t43" class="run"><span class="n"><a href="#t43">43</a></span><span class="t">    <span class="nam">overdue_msg</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Text</span><span class="op">(</span><span class="nam">string</span><span class="op">=</span><span class="str">'Overdue Payments Message'</span><span class="op">,</span> <span class="nam">translate</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t44" class="pln"><span class="n"><a href="#t44">44</a></span><span class="t">        <span class="nam">default</span><span class="op">=</span><span class="str">'''Dear Sir/Madam,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t45" class="pln"><span class="n"><a href="#t45">45</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t46" class="pln"><span class="n"><a href="#t46">46</a></span><span class="t"><span class="str">Our records indicate that some payments on your account are still due. Please find details below.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t47" class="pln"><span class="n"><a href="#t47">47</a></span><span class="t"><span class="str">If the amount has already been paid, please disregard this notice. Otherwise, please forward us the total amount stated below.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t48" class="pln"><span class="n"><a href="#t48">48</a></span><span class="t"><span class="str">If you have any queries regarding your account, Please contact us.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t49" class="pln"><span class="n"><a href="#t49">49</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t50" class="pln"><span class="n"><a href="#t50">50</a></span><span class="t"><span class="str">Thank you in advance for your cooperation.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t51" class="pln"><span class="n"><a href="#t51">51</a></span><span class="t"><span class="str">Best Regards,'''</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t52" class="pln"><span class="n"><a href="#t52">52</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t53" class="run"><span class="n"><a href="#t53">53</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t54" class="pln"><span class="n"><a href="#t54">54</a></span><span class="t">    <span class="key">def</span> <span class="nam">_check_lock_dates</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">vals</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t55" class="pln"><span class="n"><a href="#t55">55</a></span><span class="t">        <span class="str">'''Check the lock dates for the current companies. This can't be done in a api.constrains because we need</span>&nbsp;</span><span class="r"></span></p>
    <p id="t56" class="pln"><span class="n"><a href="#t56">56</a></span><span class="t"><span class="str">        to perform some comparison between new/old values. This method forces the lock dates to be irreversible.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t57" class="pln"><span class="n"><a href="#t57">57</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t58" class="pln"><span class="n"><a href="#t58">58</a></span><span class="t"><span class="str">        * You cannot define stricter conditions on advisors than on users. Then, the lock date on advisor must be set</span>&nbsp;</span><span class="r"></span></p>
    <p id="t59" class="pln"><span class="n"><a href="#t59">59</a></span><span class="t"><span class="str">        after the lock date for users.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t60" class="pln"><span class="n"><a href="#t60">60</a></span><span class="t"><span class="str">        * You cannot lock a period that is not finished yet. Then, the lock date for advisors must be set after the</span>&nbsp;</span><span class="r"></span></p>
    <p id="t61" class="pln"><span class="n"><a href="#t61">61</a></span><span class="t"><span class="str">        last day of the previous month.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t62" class="pln"><span class="n"><a href="#t62">62</a></span><span class="t"><span class="str">        * The new lock date for advisors must be set after the previous lock date.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t63" class="pln"><span class="n"><a href="#t63">63</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t64" class="pln"><span class="n"><a href="#t64">64</a></span><span class="t"><span class="str">        :param vals: The values passed to the write method.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t65" class="pln"><span class="n"><a href="#t65">65</a></span><span class="t"><span class="str">        '''</span>&nbsp;</span><span class="r"></span></p>
    <p id="t66" class="mis show_mis"><span class="n"><a href="#t66">66</a></span><span class="t">        <span class="nam">period_lock_date</span> <span class="op">=</span> <span class="nam">vals</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'period_lock_date'</span><span class="op">)</span> <span class="key">and</span><span class="xx">\</span>&nbsp;</span><span class="r"></span></p>
    <p id="t67" class="pln"><span class="n"><a href="#t67">67</a></span><span class="t">            <span class="nam">time</span><span class="op">.</span><span class="nam">strptime</span><span class="op">(</span><span class="nam">vals</span><span class="op">[</span><span class="str">'period_lock_date'</span><span class="op">]</span><span class="op">,</span> <span class="nam">DEFAULT_SERVER_DATE_FORMAT</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t68" class="mis show_mis"><span class="n"><a href="#t68">68</a></span><span class="t">        <span class="nam">fiscalyear_lock_date</span> <span class="op">=</span> <span class="nam">vals</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'fiscalyear_lock_date'</span><span class="op">)</span> <span class="key">and</span><span class="xx">\</span>&nbsp;</span><span class="r"></span></p>
    <p id="t69" class="pln"><span class="n"><a href="#t69">69</a></span><span class="t">            <span class="nam">time</span><span class="op">.</span><span class="nam">strptime</span><span class="op">(</span><span class="nam">vals</span><span class="op">[</span><span class="str">'fiscalyear_lock_date'</span><span class="op">]</span><span class="op">,</span> <span class="nam">DEFAULT_SERVER_DATE_FORMAT</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t70" class="pln"><span class="n"><a href="#t70">70</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t71" class="mis show_mis"><span class="n"><a href="#t71">71</a></span><span class="t">        <span class="nam">previous_month</span> <span class="op">=</span> <span class="nam">datetime</span><span class="op">.</span><span class="nam">strptime</span><span class="op">(</span><span class="nam">fields</span><span class="op">.</span><span class="nam">Date</span><span class="op">.</span><span class="nam">today</span><span class="op">(</span><span class="op">)</span><span class="op">,</span> <span class="nam">DEFAULT_SERVER_DATE_FORMAT</span><span class="op">)</span> <span class="op">+</span> <span class="nam">relativedelta</span><span class="op">(</span><span class="nam">months</span><span class="op">=</span><span class="op">-</span><span class="num">1</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t72" class="mis show_mis"><span class="n"><a href="#t72">72</a></span><span class="t">        <span class="nam">days_previous_month</span> <span class="op">=</span> <span class="nam">calendar</span><span class="op">.</span><span class="nam">monthrange</span><span class="op">(</span><span class="nam">previous_month</span><span class="op">.</span><span class="nam">year</span><span class="op">,</span> <span class="nam">previous_month</span><span class="op">.</span><span class="nam">month</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t73" class="mis show_mis"><span class="n"><a href="#t73">73</a></span><span class="t">        <span class="nam">previous_month</span> <span class="op">=</span> <span class="nam">previous_month</span><span class="op">.</span><span class="nam">replace</span><span class="op">(</span><span class="nam">day</span><span class="op">=</span><span class="nam">days_previous_month</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">)</span><span class="op">.</span><span class="nam">timetuple</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t74" class="mis show_mis"><span class="n"><a href="#t74">74</a></span><span class="t">        <span class="key">for</span> <span class="nam">company</span> <span class="key">in</span> <span class="nam">self</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t75" class="mis show_mis"><span class="n"><a href="#t75">75</a></span><span class="t">            <span class="nam">old_fiscalyear_lock_date</span> <span class="op">=</span> <span class="nam">company</span><span class="op">.</span><span class="nam">fiscalyear_lock_date</span> <span class="key">and</span><span class="xx">\</span>&nbsp;</span><span class="r"></span></p>
    <p id="t76" class="pln"><span class="n"><a href="#t76">76</a></span><span class="t">                <span class="nam">time</span><span class="op">.</span><span class="nam">strptime</span><span class="op">(</span><span class="nam">company</span><span class="op">.</span><span class="nam">fiscalyear_lock_date</span><span class="op">,</span> <span class="nam">DEFAULT_SERVER_DATE_FORMAT</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t77" class="pln"><span class="n"><a href="#t77">77</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t78" class="pln"><span class="n"><a href="#t78">78</a></span><span class="t">            <span class="com"># The user attempts to remove the lock date for advisors</span>&nbsp;</span><span class="r"></span></p>
    <p id="t79" class="mis show_mis"><span class="n"><a href="#t79">79</a></span><span class="t">            <span class="key">if</span> <span class="nam">old_fiscalyear_lock_date</span> <span class="key">and</span> <span class="key">not</span> <span class="nam">fiscalyear_lock_date</span> <span class="key">and</span> <span class="str">'fiscalyear_lock_date'</span> <span class="key">in</span> <span class="nam">vals</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t80" class="mis show_mis"><span class="n"><a href="#t80">80</a></span><span class="t">                <span class="key">raise</span> <span class="nam">ValidationError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'The lock date for advisors is irreversible and can\'t be removed.'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t81" class="pln"><span class="n"><a href="#t81">81</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t82" class="pln"><span class="n"><a href="#t82">82</a></span><span class="t">            <span class="com"># The user attempts to set a lock date for advisors prior to the previous one</span>&nbsp;</span><span class="r"></span></p>
    <p id="t83" class="mis show_mis"><span class="n"><a href="#t83">83</a></span><span class="t">            <span class="key">if</span> <span class="nam">old_fiscalyear_lock_date</span> <span class="key">and</span> <span class="nam">fiscalyear_lock_date</span> <span class="key">and</span> <span class="nam">fiscalyear_lock_date</span> <span class="op">&lt;</span> <span class="nam">old_fiscalyear_lock_date</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t84" class="mis show_mis"><span class="n"><a href="#t84">84</a></span><span class="t">                <span class="key">raise</span> <span class="nam">ValidationError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'The new lock date for advisors must be set after the previous lock date.'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t85" class="pln"><span class="n"><a href="#t85">85</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t86" class="pln"><span class="n"><a href="#t86">86</a></span><span class="t">            <span class="com"># In case of no new fiscal year in vals, fallback to the oldest</span>&nbsp;</span><span class="r"></span></p>
    <p id="t87" class="mis show_mis"><span class="n"><a href="#t87">87</a></span><span class="t">            <span class="key">if</span> <span class="key">not</span> <span class="nam">fiscalyear_lock_date</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t88" class="mis show_mis"><span class="n"><a href="#t88">88</a></span><span class="t">                <span class="key">if</span> <span class="nam">old_fiscalyear_lock_date</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t89" class="mis show_mis"><span class="n"><a href="#t89">89</a></span><span class="t">                    <span class="nam">fiscalyear_lock_date</span> <span class="op">=</span> <span class="nam">old_fiscalyear_lock_date</span>&nbsp;</span><span class="r"></span></p>
    <p id="t90" class="pln"><span class="n"><a href="#t90">90</a></span><span class="t">                <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t91" class="mis show_mis"><span class="n"><a href="#t91">91</a></span><span class="t">                    <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p id="t92" class="pln"><span class="n"><a href="#t92">92</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t93" class="pln"><span class="n"><a href="#t93">93</a></span><span class="t">            <span class="com"># The user attempts to set a lock date for advisors prior to the last day of previous month</span>&nbsp;</span><span class="r"></span></p>
    <p id="t94" class="mis show_mis"><span class="n"><a href="#t94">94</a></span><span class="t">            <span class="key">if</span> <span class="nam">fiscalyear_lock_date</span> <span class="op">></span> <span class="nam">previous_month</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t95" class="mis show_mis"><span class="n"><a href="#t95">95</a></span><span class="t">                <span class="key">raise</span> <span class="nam">ValidationError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'You cannot lock a period that is not finished yet. Please make sure that the lock date for advisors is not set after the last day of the previous month.'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t96" class="pln"><span class="n"><a href="#t96">96</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t97" class="pln"><span class="n"><a href="#t97">97</a></span><span class="t">            <span class="com"># In case of no new period lock date in vals, fallback to the one defined in the company</span>&nbsp;</span><span class="r"></span></p>
    <p id="t98" class="mis show_mis"><span class="n"><a href="#t98">98</a></span><span class="t">            <span class="key">if</span> <span class="key">not</span> <span class="nam">period_lock_date</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t99" class="mis show_mis"><span class="n"><a href="#t99">99</a></span><span class="t">                <span class="key">if</span> <span class="nam">company</span><span class="op">.</span><span class="nam">period_lock_date</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t100" class="mis show_mis"><span class="n"><a href="#t100">100</a></span><span class="t">                    <span class="nam">period_lock_date</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">strptime</span><span class="op">(</span><span class="nam">company</span><span class="op">.</span><span class="nam">period_lock_date</span><span class="op">,</span> <span class="nam">DEFAULT_SERVER_DATE_FORMAT</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t101" class="pln"><span class="n"><a href="#t101">101</a></span><span class="t">                <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t102" class="mis show_mis"><span class="n"><a href="#t102">102</a></span><span class="t">                    <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p id="t103" class="pln"><span class="n"><a href="#t103">103</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t104" class="pln"><span class="n"><a href="#t104">104</a></span><span class="t">            <span class="com"># The user attempts to set a lock date for advisors prior to the lock date for users</span>&nbsp;</span><span class="r"></span></p>
    <p id="t105" class="mis show_mis"><span class="n"><a href="#t105">105</a></span><span class="t">            <span class="key">if</span> <span class="nam">period_lock_date</span> <span class="op">&lt;</span> <span class="nam">fiscalyear_lock_date</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t106" class="mis show_mis"><span class="n"><a href="#t106">106</a></span><span class="t">                <span class="key">raise</span> <span class="nam">ValidationError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'You cannot define stricter conditions on advisors than on users. Please make sure that the lock date on advisor is set before the lock date for users.'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t107" class="pln"><span class="n"><a href="#t107">107</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t108" class="run"><span class="n"><a href="#t108">108</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t109" class="pln"><span class="n"><a href="#t109">109</a></span><span class="t">    <span class="key">def</span> <span class="nam">compute_fiscalyear_dates</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">date</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t110" class="pln"><span class="n"><a href="#t110">110</a></span><span class="t">        <span class="str">""" Computes the start and end dates of the fiscalyear where the given 'date' belongs to</span>&nbsp;</span><span class="r"></span></p>
    <p id="t111" class="pln"><span class="n"><a href="#t111">111</a></span><span class="t"><span class="str">            @param date: a datetime object</span>&nbsp;</span><span class="r"></span></p>
    <p id="t112" class="pln"><span class="n"><a href="#t112">112</a></span><span class="t"><span class="str">            @returns: a dictionary with date_from and date_to</span>&nbsp;</span><span class="r"></span></p>
    <p id="t113" class="pln"><span class="n"><a href="#t113">113</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t114" class="run"><span class="n"><a href="#t114">114</a></span><span class="t">        <span class="nam">self</span> <span class="op">=</span> <span class="nam">self</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t115" class="run"><span class="n"><a href="#t115">115</a></span><span class="t">        <span class="nam">last_month</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">fiscalyear_last_month</span>&nbsp;</span><span class="r"></span></p>
    <p id="t116" class="run"><span class="n"><a href="#t116">116</a></span><span class="t">        <span class="nam">last_day</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">fiscalyear_last_day</span>&nbsp;</span><span class="r"></span></p>
    <p id="t117" class="run"><span class="n"><a href="#t117">117</a></span><span class="t">        <span class="key">if</span> <span class="op">(</span><span class="nam">date</span><span class="op">.</span><span class="nam">month</span> <span class="op">&lt;</span> <span class="nam">last_month</span> <span class="key">or</span> <span class="op">(</span><span class="nam">date</span><span class="op">.</span><span class="nam">month</span> <span class="op">==</span> <span class="nam">last_month</span> <span class="key">and</span> <span class="nam">date</span><span class="op">.</span><span class="nam">day</span> <span class="op">&lt;=</span> <span class="nam">last_day</span><span class="op">)</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t118" class="pln"><span class="n"><a href="#t118">118</a></span><span class="t">            <span class="com"># FORWARD-PORT UP TO v11</span>&nbsp;</span><span class="r"></span></p>
    <p id="t119" class="run"><span class="n"><a href="#t119">119</a></span><span class="t">            <span class="key">if</span> <span class="nam">last_month</span> <span class="op">==</span> <span class="num">2</span> <span class="key">and</span> <span class="nam">last_day</span> <span class="op">==</span> <span class="num">29</span> <span class="key">and</span> <span class="nam">date</span><span class="op">.</span><span class="nam">year</span> <span class="op">%</span> <span class="num">4</span> <span class="op">!=</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t120" class="mis show_mis"><span class="n"><a href="#t120">120</a></span><span class="t">                <span class="nam">date</span> <span class="op">=</span> <span class="nam">date</span><span class="op">.</span><span class="nam">replace</span><span class="op">(</span><span class="nam">month</span><span class="op">=</span><span class="nam">last_month</span><span class="op">,</span> <span class="nam">day</span><span class="op">=</span><span class="num">28</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t121" class="pln"><span class="n"><a href="#t121">121</a></span><span class="t">            <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t122" class="run"><span class="n"><a href="#t122">122</a></span><span class="t">                <span class="nam">date</span> <span class="op">=</span> <span class="nam">date</span><span class="op">.</span><span class="nam">replace</span><span class="op">(</span><span class="nam">month</span><span class="op">=</span><span class="nam">last_month</span><span class="op">,</span> <span class="nam">day</span><span class="op">=</span><span class="nam">last_day</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t123" class="pln"><span class="n"><a href="#t123">123</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t124" class="mis show_mis"><span class="n"><a href="#t124">124</a></span><span class="t">            <span class="key">if</span> <span class="nam">last_month</span> <span class="op">==</span> <span class="num">2</span> <span class="key">and</span> <span class="nam">last_day</span> <span class="op">==</span> <span class="num">29</span> <span class="key">and</span> <span class="op">(</span><span class="nam">date</span><span class="op">.</span><span class="nam">year</span> <span class="op">+</span> <span class="num">1</span><span class="op">)</span> <span class="op">%</span> <span class="num">4</span> <span class="op">!=</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t125" class="mis show_mis"><span class="n"><a href="#t125">125</a></span><span class="t">                <span class="nam">date</span> <span class="op">=</span> <span class="nam">date</span><span class="op">.</span><span class="nam">replace</span><span class="op">(</span><span class="nam">month</span><span class="op">=</span><span class="nam">last_month</span><span class="op">,</span> <span class="nam">day</span><span class="op">=</span><span class="num">28</span><span class="op">,</span> <span class="nam">year</span><span class="op">=</span><span class="nam">date</span><span class="op">.</span><span class="nam">year</span> <span class="op">+</span> <span class="num">1</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t126" class="pln"><span class="n"><a href="#t126">126</a></span><span class="t">            <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t127" class="mis show_mis"><span class="n"><a href="#t127">127</a></span><span class="t">                <span class="nam">date</span> <span class="op">=</span> <span class="nam">date</span><span class="op">.</span><span class="nam">replace</span><span class="op">(</span><span class="nam">month</span><span class="op">=</span><span class="nam">last_month</span><span class="op">,</span> <span class="nam">day</span><span class="op">=</span><span class="nam">last_day</span><span class="op">,</span> <span class="nam">year</span><span class="op">=</span><span class="nam">date</span><span class="op">.</span><span class="nam">year</span> <span class="op">+</span> <span class="num">1</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t128" class="run"><span class="n"><a href="#t128">128</a></span><span class="t">        <span class="nam">date_to</span> <span class="op">=</span> <span class="nam">date</span>&nbsp;</span><span class="r"></span></p>
    <p id="t129" class="run"><span class="n"><a href="#t129">129</a></span><span class="t">        <span class="nam">date_from</span> <span class="op">=</span> <span class="nam">date</span> <span class="op">+</span> <span class="nam">timedelta</span><span class="op">(</span><span class="nam">days</span><span class="op">=</span><span class="num">1</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t130" class="run"><span class="n"><a href="#t130">130</a></span><span class="t">        <span class="key">if</span> <span class="nam">date_from</span><span class="op">.</span><span class="nam">month</span> <span class="op">==</span> <span class="num">2</span> <span class="key">and</span> <span class="nam">date_from</span><span class="op">.</span><span class="nam">day</span> <span class="op">==</span> <span class="num">29</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t131" class="mis show_mis"><span class="n"><a href="#t131">131</a></span><span class="t">            <span class="nam">date_from</span> <span class="op">=</span> <span class="nam">date_from</span><span class="op">.</span><span class="nam">replace</span><span class="op">(</span><span class="nam">day</span><span class="op">=</span><span class="num">28</span><span class="op">,</span> <span class="nam">year</span><span class="op">=</span><span class="nam">date_from</span><span class="op">.</span><span class="nam">year</span> <span class="op">-</span> <span class="num">1</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t132" class="pln"><span class="n"><a href="#t132">132</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t133" class="run"><span class="n"><a href="#t133">133</a></span><span class="t">            <span class="nam">date_from</span> <span class="op">=</span> <span class="nam">date_from</span><span class="op">.</span><span class="nam">replace</span><span class="op">(</span><span class="nam">year</span><span class="op">=</span><span class="nam">date_from</span><span class="op">.</span><span class="nam">year</span> <span class="op">-</span> <span class="num">1</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t134" class="run"><span class="n"><a href="#t134">134</a></span><span class="t">        <span class="key">return</span> <span class="op">{</span><span class="str">'date_from'</span><span class="op">:</span> <span class="nam">date_from</span><span class="op">,</span> <span class="str">'date_to'</span><span class="op">:</span> <span class="nam">date_to</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t135" class="pln"><span class="n"><a href="#t135">135</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t136" class="run"><span class="n"><a href="#t136">136</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_new_account_code</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">current_code</span><span class="op">,</span> <span class="nam">old_prefix</span><span class="op">,</span> <span class="nam">new_prefix</span><span class="op">,</span> <span class="nam">digits</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t137" class="mis show_mis"><span class="n"><a href="#t137">137</a></span><span class="t">        <span class="key">return</span> <span class="nam">new_prefix</span> <span class="op">+</span> <span class="nam">current_code</span><span class="op">.</span><span class="nam">replace</span><span class="op">(</span><span class="nam">old_prefix</span><span class="op">,</span> <span class="str">''</span><span class="op">,</span> <span class="num">1</span><span class="op">)</span><span class="op">.</span><span class="nam">lstrip</span><span class="op">(</span><span class="str">'0'</span><span class="op">)</span><span class="op">.</span><span class="nam">rjust</span><span class="op">(</span><span class="nam">digits</span><span class="op">-</span><span class="nam">len</span><span class="op">(</span><span class="nam">new_prefix</span><span class="op">)</span><span class="op">,</span> <span class="str">'0'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t138" class="pln"><span class="n"><a href="#t138">138</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t139" class="run"><span class="n"><a href="#t139">139</a></span><span class="t">    <span class="key">def</span> <span class="nam">reflect_code_prefix_change</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">old_code</span><span class="op">,</span> <span class="nam">new_code</span><span class="op">,</span> <span class="nam">digits</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t140" class="mis show_mis"><span class="n"><a href="#t140">140</a></span><span class="t">        <span class="nam">accounts</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.account'</span><span class="op">]</span><span class="op">.</span><span class="nam">search</span><span class="op">(</span><span class="op">[</span><span class="op">(</span><span class="str">'code'</span><span class="op">,</span> <span class="str">'like'</span><span class="op">,</span> <span class="nam">old_code</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="str">'internal_type'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="str">'liquidity'</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t141" class="pln"><span class="n"><a href="#t141">141</a></span><span class="t">            <span class="op">(</span><span class="str">'company_id'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">id</span><span class="op">)</span><span class="op">]</span><span class="op">,</span> <span class="nam">order</span><span class="op">=</span><span class="str">'code asc'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t142" class="mis show_mis"><span class="n"><a href="#t142">142</a></span><span class="t">        <span class="key">for</span> <span class="nam">account</span> <span class="key">in</span> <span class="nam">accounts</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t143" class="mis show_mis"><span class="n"><a href="#t143">143</a></span><span class="t">            <span class="key">if</span> <span class="nam">account</span><span class="op">.</span><span class="nam">code</span><span class="op">.</span><span class="nam">startswith</span><span class="op">(</span><span class="nam">old_code</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t144" class="mis show_mis"><span class="n"><a href="#t144">144</a></span><span class="t">                <span class="nam">account</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="op">{</span><span class="str">'code'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_new_account_code</span><span class="op">(</span><span class="nam">account</span><span class="op">.</span><span class="nam">code</span><span class="op">,</span> <span class="nam">old_code</span><span class="op">,</span> <span class="nam">new_code</span><span class="op">,</span> <span class="nam">digits</span><span class="op">)</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t145" class="pln"><span class="n"><a href="#t145">145</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t146" class="run"><span class="n"><a href="#t146">146</a></span><span class="t">    <span class="key">def</span> <span class="nam">reflect_code_digits_change</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">digits</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t147" class="mis show_mis"><span class="n"><a href="#t147">147</a></span><span class="t">        <span class="nam">accounts</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.account'</span><span class="op">]</span><span class="op">.</span><span class="nam">search</span><span class="op">(</span><span class="op">[</span><span class="op">(</span><span class="str">'company_id'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">id</span><span class="op">)</span><span class="op">]</span><span class="op">,</span> <span class="nam">order</span><span class="op">=</span><span class="str">'code asc'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t148" class="mis show_mis"><span class="n"><a href="#t148">148</a></span><span class="t">        <span class="key">for</span> <span class="nam">account</span> <span class="key">in</span> <span class="nam">accounts</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t149" class="mis show_mis"><span class="n"><a href="#t149">149</a></span><span class="t">            <span class="nam">account</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="op">{</span><span class="str">'code'</span><span class="op">:</span> <span class="nam">account</span><span class="op">.</span><span class="nam">code</span><span class="op">.</span><span class="nam">rstrip</span><span class="op">(</span><span class="str">'0'</span><span class="op">)</span><span class="op">.</span><span class="nam">ljust</span><span class="op">(</span><span class="nam">digits</span><span class="op">,</span> <span class="str">'0'</span><span class="op">)</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t150" class="pln"><span class="n"><a href="#t150">150</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t151" class="run"><span class="n"><a href="#t151">151</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t152" class="pln"><span class="n"><a href="#t152">152</a></span><span class="t">    <span class="key">def</span> <span class="nam">_validate_fiscalyear_lock</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">values</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t153" class="mis show_mis"><span class="n"><a href="#t153">153</a></span><span class="t">        <span class="key">if</span> <span class="nam">values</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'fiscalyear_lock_date'</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t154" class="mis show_mis"><span class="n"><a href="#t154">154</a></span><span class="t">            <span class="nam">nb_draft_entries</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move'</span><span class="op">]</span><span class="op">.</span><span class="nam">search</span><span class="op">(</span><span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p id="t155" class="pln"><span class="n"><a href="#t155">155</a></span><span class="t">                <span class="op">(</span><span class="str">'company_id'</span><span class="op">,</span> <span class="str">'in'</span><span class="op">,</span> <span class="op">[</span><span class="nam">c</span><span class="op">.</span><span class="nam">id</span> <span class="key">for</span> <span class="nam">c</span> <span class="key">in</span> <span class="nam">self</span><span class="op">]</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t156" class="pln"><span class="n"><a href="#t156">156</a></span><span class="t">                <span class="op">(</span><span class="str">'state'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="str">'draft'</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t157" class="pln"><span class="n"><a href="#t157">157</a></span><span class="t">                <span class="op">(</span><span class="str">'date'</span><span class="op">,</span> <span class="str">'&lt;='</span><span class="op">,</span> <span class="nam">values</span><span class="op">[</span><span class="str">'fiscalyear_lock_date'</span><span class="op">]</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t158" class="mis show_mis"><span class="n"><a href="#t158">158</a></span><span class="t">            <span class="key">if</span> <span class="nam">nb_draft_entries</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t159" class="mis show_mis"><span class="n"><a href="#t159">159</a></span><span class="t">                <span class="key">raise</span> <span class="nam">ValidationError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'There are still unposted entries in the period you want to lock. You should either post or delete them.'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t160" class="pln"><span class="n"><a href="#t160">160</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t161" class="run"><span class="n"><a href="#t161">161</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t162" class="pln"><span class="n"><a href="#t162">162</a></span><span class="t">    <span class="key">def</span> <span class="nam">write</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">values</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t163" class="pln"><span class="n"><a href="#t163">163</a></span><span class="t">        <span class="com">#restrict the closing of FY if there are still unposted entries</span>&nbsp;</span><span class="r"></span></p>
    <p id="t164" class="mis show_mis"><span class="n"><a href="#t164">164</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">_validate_fiscalyear_lock</span><span class="op">(</span><span class="nam">values</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t165" class="pln"><span class="n"><a href="#t165">165</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t166" class="pln"><span class="n"><a href="#t166">166</a></span><span class="t">        <span class="com"># Reflect the change on accounts</span>&nbsp;</span><span class="r"></span></p>
    <p id="t167" class="mis show_mis"><span class="n"><a href="#t167">167</a></span><span class="t">        <span class="key">for</span> <span class="nam">company</span> <span class="key">in</span> <span class="nam">self</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t168" class="mis show_mis"><span class="n"><a href="#t168">168</a></span><span class="t">            <span class="nam">digits</span> <span class="op">=</span> <span class="nam">values</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'accounts_code_digits'</span><span class="op">)</span> <span class="key">or</span> <span class="nam">company</span><span class="op">.</span><span class="nam">accounts_code_digits</span>&nbsp;</span><span class="r"></span></p>
    <p id="t169" class="mis show_mis"><span class="n"><a href="#t169">169</a></span><span class="t">            <span class="key">if</span> <span class="nam">values</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'bank_account_code_prefix'</span><span class="op">)</span> <span class="key">or</span> <span class="nam">values</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'accounts_code_digits'</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t170" class="mis show_mis"><span class="n"><a href="#t170">170</a></span><span class="t">                <span class="nam">new_bank_code</span> <span class="op">=</span> <span class="nam">values</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'bank_account_code_prefix'</span><span class="op">)</span> <span class="key">or</span> <span class="nam">company</span><span class="op">.</span><span class="nam">bank_account_code_prefix</span>&nbsp;</span><span class="r"></span></p>
    <p id="t171" class="mis show_mis"><span class="n"><a href="#t171">171</a></span><span class="t">                <span class="nam">company</span><span class="op">.</span><span class="nam">reflect_code_prefix_change</span><span class="op">(</span><span class="nam">company</span><span class="op">.</span><span class="nam">bank_account_code_prefix</span><span class="op">,</span> <span class="nam">new_bank_code</span><span class="op">,</span> <span class="nam">digits</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t172" class="mis show_mis"><span class="n"><a href="#t172">172</a></span><span class="t">            <span class="key">if</span> <span class="nam">values</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'cash_account_code_prefix'</span><span class="op">)</span> <span class="key">or</span> <span class="nam">values</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'accounts_code_digits'</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t173" class="mis show_mis"><span class="n"><a href="#t173">173</a></span><span class="t">                <span class="nam">new_cash_code</span> <span class="op">=</span> <span class="nam">values</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'cash_account_code_prefix'</span><span class="op">)</span> <span class="key">or</span> <span class="nam">company</span><span class="op">.</span><span class="nam">cash_account_code_prefix</span>&nbsp;</span><span class="r"></span></p>
    <p id="t174" class="mis show_mis"><span class="n"><a href="#t174">174</a></span><span class="t">                <span class="nam">company</span><span class="op">.</span><span class="nam">reflect_code_prefix_change</span><span class="op">(</span><span class="nam">company</span><span class="op">.</span><span class="nam">cash_account_code_prefix</span><span class="op">,</span> <span class="nam">new_cash_code</span><span class="op">,</span> <span class="nam">digits</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t175" class="mis show_mis"><span class="n"><a href="#t175">175</a></span><span class="t">            <span class="key">if</span> <span class="nam">values</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'accounts_code_digits'</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t176" class="mis show_mis"><span class="n"><a href="#t176">176</a></span><span class="t">                <span class="nam">company</span><span class="op">.</span><span class="nam">reflect_code_digits_change</span><span class="op">(</span><span class="nam">digits</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t177" class="pln"><span class="n"><a href="#t177">177</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t178" class="pln"><span class="n"><a href="#t178">178</a></span><span class="t">            <span class="com">#forbid the change of currency_id if there are already some accounting entries existing</span>&nbsp;</span><span class="r"></span></p>
    <p id="t179" class="mis show_mis"><span class="n"><a href="#t179">179</a></span><span class="t">            <span class="key">if</span> <span class="str">'currency_id'</span> <span class="key">in</span> <span class="nam">values</span> <span class="key">and</span> <span class="nam">values</span><span class="op">[</span><span class="str">'currency_id'</span><span class="op">]</span> <span class="op">!=</span> <span class="nam">company</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">.</span><span class="nam">id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t180" class="mis show_mis"><span class="n"><a href="#t180">180</a></span><span class="t">                <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move.line'</span><span class="op">]</span><span class="op">.</span><span class="nam">search</span><span class="op">(</span><span class="op">[</span><span class="op">(</span><span class="str">'company_id'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="nam">company</span><span class="op">.</span><span class="nam">id</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t181" class="mis show_mis"><span class="n"><a href="#t181">181</a></span><span class="t">                    <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'You cannot change the currency of the company since some journal items already exist'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t182" class="pln"><span class="n"><a href="#t182">182</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t183" class="mis show_mis"><span class="n"><a href="#t183">183</a></span><span class="t">        <span class="key">return</span> <span class="nam">super</span><span class="op">(</span><span class="nam">ResCompany</span><span class="op">,</span> <span class="nam">self</span><span class="op">)</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="nam">values</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
</div>
<div id="footer">
    <div class="content">
        <p>
            <a class="nav" href="index.html">&#xab; index</a> &nbsp; &nbsp; <a class="nav" href="https://coverage.readthedocs.io">coverage.py v5.4</a>,
            created at 2021-02-24 19:43
        </p>
    </div>
</div>
</body>
</html>
